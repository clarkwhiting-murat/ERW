<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COâ‚‚ Retention Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Global transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }
        
        /* CSS Variables for Consistent Colors */
        :root {
            /* Text Colors - Light Mode */
            --text-primary: #111827;        /* Headings (H1, H2, H3) */
            --text-secondary: #374151;      /* Body text, paragraphs */
            --text-muted: #64748b;          /* Labels, hints, secondary info */
            --text-tertiary: #9ca3af;       /* Very muted text */
            
            /* Accent Colors */
            --accent-primary: #4F46E5;       /* Primary accent (indigo) */
            --accent-hover: #4338ca;        /* Accent hover state */
            --accent-light: #eef2ff;        /* Light accent background */
            
            /* Background Colors */
            --bg-primary: #f3f4f6;          /* Main background */
            --bg-card: #ffffff;             /* Card background */
            --bg-hover: #f8fafc;            /* Hover background */
            --bg-input: #ffffff;            /* Input background */
            --bg-button: #4F46E5;           /* Button background */
            --bg-button-hover: #4338ca;     /* Button hover background */
            --bg-button-secondary: #6b7280; /* Secondary button background */
            --bg-button-secondary-hover: #4b5563; /* Secondary button hover */
            --bg-outline: #ffffff;          /* Outline button background */
            --bg-outline-hover: #f9fafb;    /* Outline button hover */
            --bg-toggle: #ffffff;           /* Toggle/switch background */
            --bg-muted: #f5f5f5;            /* Muted background areas */
            
            /* Border Colors */
            --border-primary: #e5e7eb;      /* Primary borders */
            --border-secondary: #cbd5e1;    /* Secondary borders */
            --border-input: #d1d5db;        /* Input borders */
            --border-input-focus: #4F46E5; /* Input focus border */
            --border-button: transparent;   /* Button border */
            --border-outline: #e5e7eb;      /* Outline button border */
            --border-outline-hover: #4F46E5; /* Outline button hover border */
            
            /* Message/Alert Colors */
            --success-bg: #d1fae5;          /* Success message background */
            --success-text: #065f46;       /* Success message text */
            --success-border: #a7f3d0;     /* Success message border */
            --error-bg: #fee2e2;            /* Error message background */
            --error-text: #991b1b;         /* Error message text */
            --error-border: #fecaca;        /* Error message border */
            
            /* Icon Colors */
            --icon-primary: #1e293b;        /* Primary icon color */
            --icon-secondary: #64748b;       /* Secondary icon color */
            
            /* Tooltip Colors */
            --tooltip-bg: #1e293b;          /* Tooltip background */
            --tooltip-text: #ffffff;        /* Tooltip text */
            --tooltip-border: rgba(255, 255, 255, 0.2); /* Tooltip border */
        }
        
        body.dark-mode {
            /* Text Colors - Dark Mode */
            --text-primary: #f3f4f6;        /* Headings (H1, H2, H3) */
            --text-secondary: #d1d5db;      /* Body text, paragraphs */
            --text-muted: #9ca3af;          /* Labels, hints, secondary info */
            --text-tertiary: #6b7280;       /* Very muted text */
            
            /* Accent Colors (same in dark mode) */
            --accent-primary: #4F46E5;
            --accent-hover: #5b51ea;
            --accent-light: #312e81;        /* Light accent background (dark mode) */
            
            /* Background Colors - Dark Mode */
            --bg-primary: #111827;          /* Main background */
            --bg-card: #1f2937;             /* Card background */
            --bg-hover: #374151;            /* Hover background */
            --bg-input: #1f2937;            /* Input background */
            --bg-button: #4F46E5;           /* Button background */
            --bg-button-hover: #5b51ea;    /* Button hover background */
            --bg-button-secondary: #6b7280; /* Secondary button background */
            --bg-button-secondary-hover: #4b5563; /* Secondary button hover */
            --bg-outline: #1f2937;          /* Outline button background */
            --bg-outline-hover: #374151;    /* Outline button hover */
            --bg-toggle: #1f2937;           /* Toggle/switch background */
            --bg-muted: #1f2937;             /* Muted background areas */
            
            /* Border Colors - Dark Mode */
            --border-primary: #374151;      /* Primary borders */
            --border-secondary: #4b5563;    /* Secondary borders */
            --border-input: #374151;         /* Input borders */
            --border-input-focus: #4F46E5;  /* Input focus border */
            --border-button: transparent;   /* Button border */
            --border-outline: #374151;       /* Outline button border */
            --border-outline-hover: #4F46E5; /* Outline button hover border */
            
            /* Message/Alert Colors - Dark Mode */
            --success-bg: #064e3b;          /* Success message background */
            --success-text: #6ee7b7;        /* Success message text */
            --success-border: #10b981;      /* Success message border */
            --error-bg: #7f1d1d;            /* Error message background */
            --error-text: #fca5a5;          /* Error message text */
            --error-border: #dc2626;        /* Error message border */
            
            /* Icon Colors - Dark Mode */
            --icon-primary: #f3f4f6;        /* Primary icon color */
            --icon-secondary: #9ca3af;       /* Secondary icon color */
            
            /* Tooltip Colors - Dark Mode (same as light for consistency) */
            --tooltip-bg: #1e293b;          /* Tooltip background */
            --tooltip-text: #ffffff;        /* Tooltip text */
            --tooltip-border: rgba(255, 255, 255, 0.2); /* Tooltip border */
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: var(--text-secondary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Typography System - Consistent Font Colors and Formats */
        /* All text elements use CSS variables for consistent theming */
        
        /* Headings - Use --text-primary */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* Body text - Use --text-secondary */
        p, body, div, span {
            color: var(--text-secondary);
        }
        
        /* Muted text - Use --text-muted */
        .intro-text, .field-explanation, .result-explanation, 
        label, .sidebar-nav-item, .sidebar-footer-link {
            color: var(--text-muted);
        }
        
        /* Very muted text - Use --text-tertiary */
        input::placeholder, textarea::placeholder, 
        .sidebar-dark-mode-toggle-label {
            color: var(--text-tertiary);
        }
        
        /* Accent colors - Use --accent-primary */
        .result-value, .sidebar-nav-item.active,
        a:hover, button:hover {
            color: var(--accent-primary);
        }
        
        /* Ensure all headings maintain consistent color */
        h1 { font-size: 2.25em; font-weight: 700; }
        h2 { font-size: 1.75em; font-weight: 700; }
        h3 { font-size: 1.25em; font-weight: 600; }
        h4 { font-size: 1em; font-weight: 600; }
        
        /* Fade-in animation for tab content */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Slide-down animation for collapsible content */
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 2000px;
                transform: translateY(0);
            }
        }
        
        /* Slide-up animation for collapsible content */
        @keyframes slideUp {
            from {
                opacity: 1;
                max-height: 2000px;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
        }
        
        /* Scale animation for buttons */
        @keyframes buttonPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-primary);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
        }
        
        body.dark-mode .sidebar {
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .sidebar-logo:hover {
            opacity: 0.7;
            transform: scale(1.05);
        }
        
        .sidebar-logo-svg {
            width: 32px;
            height: 32px;
            color: var(--text-primary);
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            flex: 1;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .sidebar-nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-left-color: var(--border-secondary);
        }
        
        .sidebar-nav-item.active {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            font-weight: 600;
        }
        
        body.dark-mode .sidebar-nav-item.active {
            background: var(--accent-light);
            color: var(--accent-hover);
            border-left-color: var(--accent-primary);
        }
        
        .sidebar-nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        /* Sidebar Footer */
        .sidebar-footer {
            padding: 16px 20px 24px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Dark Mode Toggle in Sidebar */
        .sidebar-dark-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
            color: var(--text-muted);
            width: auto;
            min-width: 100px;
            max-width: 120px;
        }
        
        .sidebar-dark-mode-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--border-secondary);
        }
        
        .sidebar-dark-mode-toggle-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        
        .sidebar-dark-mode-toggle-label {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .sidebar-footer-main {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            background: var(--bg-button);
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .sidebar-footer-main:hover {
            background: var(--bg-button-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }
        
        .sidebar-footer-link {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 11px;
            font-weight: 400;
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 1px solid transparent;
        }
        
        .sidebar-footer-link:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        
        body.dark-mode .sidebar-footer-link:hover {
            color: var(--accent-hover);
            border-bottom-color: var(--accent-hover);
        }
        
        
        /* Main content area */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            transition: margin-left 0.3s ease, padding 0.3s ease;
        }
        
        .sidebar:not(.collapsed) ~ .main-wrapper .container {
            margin-left: 280px;
            padding: 40px 48px;
        }
        
        .sidebar.collapsed ~ .main-wrapper .container {
            margin-left: 0;
            padding: 40px 48px;
        }
        
        /* 12-column grid system */
        .grid-12 {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        
        .col-span-12 { grid-column: span 12; }
        .col-span-11 { grid-column: span 11; }
        .col-span-10 { grid-column: span 10; }
        .col-span-9 { grid-column: span 9; }
        .col-span-8 { grid-column: span 8; }
        .col-span-7 { grid-column: span 7; }
        .col-span-6 { grid-column: span 6; }
        .col-span-5 { grid-column: span 5; }
        .col-span-4 { grid-column: span 4; }
        .col-span-3 { grid-column: span 3; }
        .col-span-2 { grid-column: span 2; }
        .col-span-1 { grid-column: span 1; }
        
        /* SaaS Card Container */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-primary);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
        }
        
        body.dark-mode .card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Model explanation box */
        .model-explanation-box {
            background: var(--bg-hover);
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 40px;
            border: 1px solid var(--border-primary);
        }
        
        .model-explanation-box h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            border: none;
            padding: 0;
        }
        
        .model-explanation-box ol {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-left: 20px;
        }
        
        body.dark-mode .model-explanation-box {
            background: var(--bg-card);
            border-color: var(--border-primary);
        }
        
        /* Technical documentation styles - Consistent with app design system */
        .tech-doc-h1 {
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 2em;
            font-weight: 700;
            line-height: 1.3;
        }
        
        .tech-doc-h2 {
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin-top: 32px;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .tech-doc-h3 {
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin-top: 28px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border-primary);
            padding-bottom: 8px;
            font-size: 1.25em;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .tech-doc-p {
            color: var(--text-secondary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.7;
            margin-bottom: 16px;
            font-size: 1em;
        }
        
        .tech-doc-code-block {
            background: var(--bg-muted);
            border: 1px solid var(--border-primary);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .tech-doc-code-block code {
            color: var(--text-primary);
            background: transparent;
            padding: 0;
            border-radius: 0;
            font-size: inherit;
        }
        
        body.dark-mode .tech-doc-code-block {
            background: var(--bg-muted);
            border-color: var(--border-primary);
        }
        
        .tech-doc-code-inline {
            background: var(--bg-muted);
            border: 1px solid var(--border-primary);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 0.9em;
            color: var(--accent-primary);
        }
        
        body.dark-mode .tech-doc-code-inline {
            background: var(--bg-muted);
            border-color: var(--border-primary);
            color: var(--accent-primary);
        }
        
        /* Technical documentation container styling */
        #technicalContent {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #technicalContent strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        #technicalContent em {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Lists in technical documentation */
        #technicalContent ul,
        #technicalContent ol {
            color: var(--text-secondary);
            margin: 16px 0;
            padding-left: 24px;
            line-height: 1.7;
        }
        
        #technicalContent li {
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.7;
        }
        
        #technicalContent ul li {
            list-style-type: disc;
        }
        
        #technicalContent ol li {
            list-style-type: decimal;
        }
        
        /* Ensure consistent spacing between sections */
        #technicalContent > *:first-child {
            margin-top: 0;
        }
        
        #technicalContent > *:last-child {
            margin-bottom: 0;
        }
        
        /* Message styling */
        .error-message {
            color: var(--error-text);
            line-height: 1.6;
        }
        
        .success-message {
            color: var(--success-text);
            line-height: 1.6;
        }
        
        /* Section spacing */
        .section-spacing {
            margin-bottom: 40px;
        }
        
        .section-spacing-sm {
            margin-bottom: 32px;
        }
        
        /* Responsive: Hide sidebar on small screens, show toggle */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar:not(.collapsed) {
                transform: translateX(0);
            }
            
            .sidebar:not(.collapsed) ~ .main-wrapper .container {
                margin-left: 0;
                padding-left: 20px;
                padding-right: 20px;
            }
            
            
        }
        
        .main-wrapper {
            min-height: 100vh;
        }
        
        /* Dark mode toggle button */
        /* Old dark mode toggle styles removed - now in sidebar */
        
        h1 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.25em;
            font-weight: 700;
            letter-spacing: -0.03em;
            transition: opacity 0.3s;
        }
        
        h1:hover {
            opacity: 0.7;
            cursor: pointer;
        }
        
        .tabs {
            display: none;
            gap: 0;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .tabs.active {
            display: flex;
        }
        
        
        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .tab-content > * + * {
            margin-top: 32px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.25s ease forwards;
        }
        
        .form-group {
            margin-bottom: 28px;
            display: flex;
            flex-direction: column;
        }
        
        .grid .form-group {
            height: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: -0.01em;
        }
        
        body.dark-mode label {
            color: var(--text-secondary);
        }
        
        .field-explanation {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 6px;
            margin-bottom: 12px;
            line-height: 1.5;
            flex-grow: 1;
        }
        
        .form-group input,
        .form-group select {
            margin-top: auto;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-input);
            color: var(--text-secondary);
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: var(--border-secondary);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--border-input-focus);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: scale(1);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Readonly input styling */
        input[readonly], 
        input.readonly-input,
        textarea[readonly] {
            background: var(--bg-muted);
            cursor: not-allowed;
        }
        
        body.dark-mode input[readonly],
        body.dark-mode input.readonly-input,
        body.dark-mode textarea[readonly] {
            background: var(--bg-muted);
            opacity: 0.8;
        }
        
        /* SaaS Button Styles */
        button, .btn {
            background: var(--bg-button);
            color: white;
            padding: 12px 24px;
            border: 1px solid var(--border-button);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transform: translateY(0);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button svg, .btn svg {
            transition: transform 0.2s ease;
        }
        
        /* Primary Button (default) */
        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            background: var(--bg-button-hover);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
            transform: translateY(-1px);
        }
        
        button:hover:not(:disabled) svg, .btn:hover:not(:disabled) svg {
            transform: translateX(2px);
        }
        
        button:active:not(:disabled), .btn:active:not(:disabled) {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }
        
        button:active:not(:disabled) svg, .btn:active:not(:disabled) svg {
            transform: translateX(0);
        }
        
        /* Secondary Button */
        button.btn-secondary, .btn-secondary {
            background: var(--bg-button-secondary);
            color: white;
        }
        
        button.btn-secondary:hover:not(:disabled), .btn-secondary:hover:not(:disabled) {
            background: var(--bg-button-secondary-hover);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.25);
        }
        
        /* Outline Button */
        button.btn-outline, .btn-outline {
            background: var(--bg-outline);
            color: var(--accent-primary);
            border: 1px solid var(--border-outline);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        button.btn-outline:hover:not(:disabled), .btn-outline:hover:not(:disabled) {
            background: var(--bg-outline-hover);
            border-color: var(--border-outline-hover);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }
        
        body.dark-mode button.btn-outline, body.dark-mode .btn-outline {
            color: var(--accent-hover);
        }
        
        /* Disabled State */
        button:disabled, .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        button:disabled:hover, .btn:disabled:hover {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .message {
            margin-top: 20px;
            padding: 14px 18px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        
        .message.success {
            background: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-border);
        }
        
        .message.error {
            background: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
        }
        
        .message.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeIn 0.25s ease forwards;
        }
        
        .results {
            margin-top: 32px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        pre {
            background: var(--bg-muted);
            color: var(--text-primary);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            border: 1px solid var(--border-primary);
        }
        
        body.dark-mode pre {
            background: var(--bg-muted);
            color: var(--text-secondary);
            border-color: var(--border-primary);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        h2 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.75em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        h3 {
            color: var(--text-primary);
            margin-top: 32px;
            margin-bottom: 16px;
            font-size: 1.25em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        h4 {
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .section-divider {
            margin: 30px 0;
            border-top: 1px solid var(--border-primary);
        }
        
        .intro-text {
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .result-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            transform: translateY(0);
        }
        
        .result-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--border-secondary);
        }
        
        body.dark-mode .result-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-color: var(--border-secondary);
        }
        
        .result-card h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .result-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }
        
        .result-explanation {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #4F46E5;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
            transition: all 0.2s ease;
            transform: scale(1);
            position: relative;
        }
        
        .step-number.completed {
            background: #10b981;
        }
        
        .step-number.completed svg {
            width: 16px;
            height: 16px;
            stroke-width: 3;
        }
        
        .step-number:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .step-number.completed:hover {
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 6px;
        }
        
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-hover);
            color: var(--icon-secondary);
            cursor: help;
            vertical-align: middle;
            transition: all 0.2s ease;
            transform: scale(1);
        }
        
        .tooltip-icon svg {
            width: 12px;
            height: 12px;
            stroke-width: 2.5;
            transition: all 0.2s ease;
        }
        
        .tooltip-icon:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        
        .tooltip-icon:hover svg {
            color: white;
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 12px 16px;
            border-radius: 8px;
            width: 300px;
            font-size: 13px;
            line-height: 1.6;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--tooltip-bg);
            transition: opacity 0.2s ease;
        }
        
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .tooltip-content strong {
            display: block;
            margin-bottom: 8px;
            color: var(--tooltip-text);
            font-weight: 600;
        }
        
        .tooltip-content .example {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--tooltip-border);
            color: var(--text-secondary);
        }
        
        body.dark-mode .tooltip-content .example {
            color: var(--text-muted);
        }
        
        .collapsible-section {
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            background: var(--bg-card);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: all 0.2s ease;
        }
        
        body.dark-mode .collapsible-section {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .collapsible-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
        }
        
        body.dark-mode .collapsible-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .collapsible-header {
            background: var(--bg-hover);
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .collapsible-header:hover {
            background: var(--bg-hover);
        }
        
        .collapsible-header h3 {
            margin: 0;
            padding: 0;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }
        
        .collapsible-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            color: #64748b;
            transition: transform 0.3s ease, color 0.2s ease;
        }
        
        .collapsible-toggle svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
            transition: inherit;
        }
        
        body.dark-mode .collapsible-toggle {
            color: #9ca3af;
        }
        
        .collapsible-header:hover .collapsible-toggle {
            color: #4F46E5;
        }
        
        body.dark-mode .collapsible-header:hover .collapsible-toggle {
            color: #818cf8;
        }
        
        .collapsible-section.expanded .collapsible-toggle {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            padding: 24px;
            display: none;
            background: white;
            overflow: hidden;
        }
        
        body.dark-mode .collapsible-content {
            background: #1f2937;
        }
        
        .collapsible-section.expanded .collapsible-content {
            display: block;
            animation: slideDown 0.3s ease forwards;
        }
        
        .collapsible-section:not(.expanded) .collapsible-content {
            animation: slideUp 0.3s ease forwards;
        }
        
        .json-example {
            background: #f8fafc;
            border-left: 3px solid #4F46E5;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.7;
            color: #1e293b;
            transition: all 0.2s ease;
        }
        
        body.dark-mode .json-example {
            background: #374151;
            color: #e5e7eb;
        }
        
        .json-example:hover {
            background: #f1f5f9;
            border-left-color: #4338ca;
        }
        
        body.dark-mode .json-example:hover {
            background: #4b5563;
        }
        
        .section-divider {
            margin: 40px 0;
            border-top: 1px solid #e5e7eb;
        }
        
        body.dark-mode .section-divider {
            border-top-color: #374151;
        }
        
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #334155;
        }
        
        textarea[readonly] {
            background: #f8fafc;
            border-color: #e5e7eb;
            cursor: default;
        }
        
        body.dark-mode textarea[readonly] {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        
        textarea[readonly]:focus {
            border-color: #cbd5e1;
            box-shadow: none;
        }
        
        body.dark-mode textarea[readonly]:focus {
            border-color: #6b7280;
        }
        
        footer {
            text-align: center;
            margin-top: 60px;
            padding: 32px 20px;
            color: #64748b;
            background: transparent;
        }
        
        body.dark-mode footer {
            color: #9ca3af;
        }
        
        .report-content-box {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
            color: var(--text-secondary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body.dark-mode .report-content-box {
            background: var(--bg-card);
            border-color: var(--border-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .report-content-box:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        body.dark-mode .report-content-box:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }
        
        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* ===========================================
           RESPONSIVE BREAKPOINTS
           =========================================== */
        
        /* Extra Large (xl) - 1280px and below */
        @media (max-width: 1280px) {
            .container {
                max-width: 1200px;
            }
            
            h1 {
                font-size: 2.5em;
            }
            
            .sidebar:not(.collapsed) ~ .main-wrapper .container {
                margin-left: 280px;
                padding-left: 30px;
                padding-right: 30px;
            }
        }
        
        /* Large (lg) - 1024px and below */
        @media (max-width: 1024px) {
            .container {
                max-width: 960px;
            }
            
            h1 {
                font-size: 2.25em;
                margin-bottom: 36px;
            }
            
            h2 {
                font-size: 1.75em;
            }
            
            h3 {
                font-size: 1.25em;
            }
            
            /* Landing page typography scaling */
            #start-here h2 {
                font-size: 2em;
            }
            
            #start-here .intro-text {
                font-size: 15px;
            }
            
            #start-here h3 {
                font-size: 1.35em;
            }
            
            #start-here h4 {
                font-size: 15px;
            }
            
            #start-here p {
                font-size: 13px;
            }
            
            /* Two-column layouts start collapsing */
            .result-card {
                min-width: 200px;
            }
            
            /* Adjust sidebar */
            .sidebar:not(.collapsed) ~ .main-wrapper .container {
                margin-left: 280px;
                padding-left: 24px;
                padding-right: 24px;
            }
            
            .sidebar.collapsed ~ .main-wrapper .container {
                padding-left: 24px;
                padding-right: 24px;
            }
        }
        
        /* Medium (md) - 768px and below */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.875em;
                margin-bottom: 28px;
            }
            
            h2 {
                font-size: 1.5em;
            }
            
            h3 {
                font-size: 1.125em;
            }
            
            /* Landing page - mobile optimized */
            #start-here h2 {
                font-size: 1.75em;
            }
            
            #start-here .intro-text {
                font-size: 14px;
            }
            
            #start-here h3 {
                font-size: 1.25em;
                margin-top: 30px;
                margin-bottom: 20px;
            }
            
            #start-here h4 {
                font-size: 14px;
            }
            
            #start-here p {
                font-size: 13px;
                line-height: 1.6;
            }
            
            #start-here .step-number {
                width: 32px;
                height: 32px;
                font-size: 16px;
                margin-right: 12px;
            }
            
            #start-here > div {
                max-width: 100% !important;
            }
            
            #start-here button {
                font-size: 16px;
                padding: 13px 26px;
                max-width: 100% !important;
            }
            
            /* Cards collapse to single column */
            .results {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            .result-card {
                width: 100%;
                min-width: unset;
                margin: 0;
            }
            
            /* Form groups stack */
            .form-group {
                margin-bottom: 20px;
            }
            
            /* Buttons full width on mobile */
            button {
                padding: 13px 24px;
                font-size: 14px;
            }
            
            /* Adjust collapsible sections */
            .collapsible-header {
                padding: 16px 18px;
            }
            
            .collapsible-content {
                padding: 18px;
            }
            
            /* Tab content padding */
            .tab-content {
                padding: 24px 20px;
            }
            
            /* Sidebar behavior - hidden by default */
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar:not(.collapsed) {
                transform: translateX(0);
                box-shadow: 4px 0 16px rgba(0, 0, 0, 0.2);
            }
            
            .sidebar:not(.collapsed) ~ .main-wrapper .container {
                margin-left: 0;
                padding-left: 20px;
                padding-right: 20px;
            }
            
            .sidebar.collapsed ~ .main-wrapper .container {
                padding-left: 20px;
                padding-right: 20px;
            }
            
            
            
            /* Tooltips adjust position */
            .tooltip-content {
                min-width: 200px;
                max-width: 280px;
                font-size: 12px;
                padding: 10px 12px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
            
            .tooltip-content::after {
                left: 50%;
                transform: translateX(-50%);
            }
            
            .tooltip-icon {
                width: 16px;
                height: 16px;
            }
            
            .tooltip-icon svg {
                width: 10px;
                height: 10px;
            }
            
            /* Footer buttons stack */
            footer {
                padding: 24px 20px;
            }
            
            
            /* Input fields */
            input,
            select,
            textarea {
                font-size: 15px;
                padding: 11px 14px;
            }
            
            label {
                font-size: 14px;
            }
            
            .field-explanation {
                font-size: 12px;
            }
        }
        
        /* Small (sm) - 480px and below */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            h1 {
                font-size: 1.625em;
                margin-bottom: 24px;
            }
            
            h2 {
                font-size: 1.375em;
            }
            
            h3 {
                font-size: 1.0625em;
            }
            
            /* Landing page - small mobile */
            #start-here h2 {
                font-size: 1.5em;
                line-height: 1.3;
            }
            
            #start-here .intro-text {
                font-size: 13px;
            }
            
            #start-here h3 {
                font-size: 1.125em;
                margin-top: 24px;
                margin-bottom: 16px;
            }
            
            #start-here h4 {
                font-size: 13px;
            }
            
            #start-here p {
                font-size: 12px;
                line-height: 1.6;
            }
            
            #start-here .step-number {
                width: 28px;
                height: 28px;
                font-size: 14px;
                margin-right: 10px;
            }
            
            #start-here button {
                font-size: 15px;
                padding: 12px 24px;
            }
            
            /* Sidebar width reduced */
            .sidebar {
                width: 260px;
            }
            
            .sidebar-header {
                padding: 20px 16px;
            }
            
            .sidebar-title {
                font-size: 16px;
            }
            
            .sidebar-nav-item {
                padding: 11px 16px;
                font-size: 14px;
            }
            
            .sidebar-nav-item-icon {
                width: 18px;
                height: 18px;
                margin-right: 10px;
            }
            
            /* Containers */
            .container {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 32px;
            }
            
            .sidebar:not(.collapsed) ~ .main-wrapper .container,
            .sidebar.collapsed ~ .main-wrapper .container {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 32px;
            }
            
            /* Tab content */
            .tab-content {
                padding: 20px 16px;
                border-radius: 10px;
            }
            
            /* Cards */
            .result-card {
                padding: 18px;
                border-radius: 10px;
            }
            
            .result-value {
                font-size: 1.75em;
            }
            
            /* Collapsible sections */
            .collapsible-header {
                padding: 14px 16px;
                flex-wrap: wrap;
            }
            
            .collapsible-header h3 {
                font-size: 14px;
            }
            
            .collapsible-content {
                padding: 16px;
            }
            
            /* Buttons stack vertically */
            button {
                padding: 12px 20px;
                font-size: 14px;
                border-radius: 7px;
            }
            
            /* Button groups stack */
            div[style*="display: flex"] button,
            div[style*="display:flex"] button {
                margin-bottom: 10px;
            }
            
            /* Form inputs */
            input,
            select,
            textarea {
                font-size: 15px;
                padding: 10px 12px;
                border-radius: 7px;
            }
            
            label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .field-explanation {
                font-size: 11px;
                margin-top: 6px;
            }
            
            /* Messages */
            .message {
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 7px;
            }
            
            /* Tooltips - simpler on tiny screens */
            .tooltip-content {
                min-width: 180px;
                max-width: 260px;
                font-size: 11px;
                padding: 8px 10px;
            }
            
            /* Footer */
            footer {
                padding: 20px 16px;
                margin-top: 32px;
            }
            
            
            /* Dark mode toggle */
            
            /* Sidebar toggle */
            
            /* JSON examples and code blocks */
            .json-example {
                padding: 12px;
                font-size: 11px;
                border-radius: 7px;
            }
            
            pre {
                padding: 12px;
                font-size: 11px;
                border-radius: 7px;
            }
            
            /* Report content */
            textarea[readonly] {
                font-size: 12px;
                padding: 12px;
            }
        }
        
        /* Utility: Force full width on specific button containers */
        @media (max-width: 768px) {
            div[style*="max-width: 300px"],
            button[style*="max-width: 300px"] {
                max-width: 100% !important;
            }
        }
        
        /* Flexbox and Grid responsive utilities */
        @media (max-width: 768px) {
            /* Any flex containers should wrap */
            [style*="display: flex"]:not(.sidebar-nav):not(.sidebar-header) {
                flex-wrap: wrap;
            }
            
            /* Landing page step descriptions */
            #start-here [style*="display: flex"] {
                flex-direction: row;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            /* Landing page steps stack more on tiny screens */
            #start-here [style*="display: flex"][style*="align-items: start"] {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo" onclick="showMainPage(); return false;" style="cursor: pointer;" title="Go to Main Page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sidebar-logo-svg">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="sidebar-nav-item" onclick="showStep('scenario'); return false;" id="nav-scenario">
                <svg class="sidebar-nav-item-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Define Scenario
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showStep('evidence'); return false;" id="nav-evidence">
                <svg class="sidebar-nav-item-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Add Evidence
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showStep('analysis'); return false;" id="nav-analysis">
                <svg class="sidebar-nav-item-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Run Analysis
            </a>
            <a href="#" class="sidebar-nav-item" onclick="showStep('report'); return false;" id="nav-report">
                <svg class="sidebar-nav-item-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Generate Report
            </a>
        </nav>
        <div style="padding: 16px 20px; display: flex; justify-content: center;">
            <button class="sidebar-dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
                <svg id="sunIcon" class="sidebar-dark-mode-toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moonIcon" class="sidebar-dark-mode-toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
                <span class="sidebar-dark-mode-toggle-label" id="darkModeText">Dark Mode</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <a href="#" class="sidebar-footer-main" onclick="showMainPage(); return false;">
                Main Page
            </a>
            <a href="#" class="sidebar-footer-link" onclick="showTechnicalRationale(); return false;">
                Technical Rationale
            </a>
        </div>
    </aside>
    
    <!-- Sidebar Toggle Button -->
    
    <div class="main-wrapper">
        <div class="container" id="miningSimulationDashboard">
            <h1 style="cursor: pointer;" onclick="showMainPage()">ðŸŒ COâ‚‚ Retention Simulator</h1>
        
        <!-- Start Here Landing Page -->
        <div id="start-here" class="tab-content active">
            <h2>Welcome to the COâ‚‚ Retention Simulator</h2>
            <p class="intro-text" style="font-size: 16px; margin-bottom: 30px;">
                This tool helps you estimate how much COâ‚‚ can be removed over 10 years when applying 
                enhanced rock weathering materials to agricultural land. The simulator uses Bayesian 
                uncertainty modeling to provide both expected values and conservative estimates suitable 
                for carbon credit issuance.
            </p>
            
            <h3 style="margin-top: 40px; margin-bottom: 24px;">How It Works</h3>
            
            <div style="max-width: 800px;">
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: start; margin-bottom: 15px;">
                        <div class="step-number" style="flex-shrink: 0;">1</div>
                        <div>
                            <h4 style="margin-bottom: 8px; font-size: 16px;">Define Scenario</h4>
                            <p class="intro-text" style="line-height: 1.7; font-size: 14px;">
                                Start by entering details about your rock source, chemistry, particle size, 
                                application rate, and site conditions. A <strong>scenario</strong> represents one 
                                specific combination of these parameters. The simulator will estimate COâ‚‚ removal 
                                and uncertainty for this scenario over a 10-year period. You'll provide information 
                                about the deposit, rock product name, size fraction, application rate, rock chemistry 
                                (MgO% and CaO%), and climate conditions.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: start; margin-bottom: 15px;">
                        <div class="step-number" style="flex-shrink: 0;">2</div>
                        <div>
                            <h4 style="margin-bottom: 8px; font-size: 16px;">Add Evidence</h4>
                            <p class="intro-text" style="line-height: 1.6; font-size: 14px;">
                                Provide measurement data that the model will learn from. <strong>Laboratory data</strong> 
                                tell us how fast the rock reacts with COâ‚‚ under controlled conditions, helping us 
                                estimate the weathering rate (how quickly COâ‚‚ is taken up per month per tonne of rock). 
                                <strong>Field data</strong> confirm how the rock behaves in real soil and climate conditions 
                                over time windows (e.g., 12-month periods). Both data sources feed into the same uncertainty 
                                modelâ€”the more evidence you provide, the more confident the model becomes.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; align-items: start; margin-bottom: 15px;">
                        <div class="step-number" style="flex-shrink: 0;">3</div>
                        <div>
                            <h4 style="margin-bottom: 8px; font-size: 16px;">Run Analysis</h4>
                            <p class="intro-text" style="line-height: 1.6; font-size: 14px;">
                                Once you've defined your scenario and added evidence, the simulator will combine all 
                                available data and run the uncertainty model. The system will:
                            </p>
                            <ul class="intro-text" style="line-height: 1.8; font-size: 14px; margin-left: 20px; margin-top: 8px;">
                                <li>Update the Bayesian model state using your latest lab and field measurements</li>
                                <li>Run thousands of Monte Carlo simulations over 10 years in monthly steps</li>
                                <li>Apply discrete risks (drought, misapplication, etc.) if a risk profile is specified</li>
                                <li>Calculate a full distribution of total COâ‚‚ removal with confidence intervals</li>
                            </ul>
                            <p class="intro-text" style="line-height: 1.6; font-size: 14px; margin-top: 8px;">
                                The results include a <strong>conservative 5th percentile estimate</strong>, which represents 
                                the value you can use for carbon credit issuance with 95% confidence that actual COâ‚‚ removal 
                                will be at least this amount.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; align-items: start; margin-bottom: 15px;">
                        <div class="step-number" style="flex-shrink: 0;">4</div>
                        <div>
                            <h4 style="margin-bottom: 8px; font-size: 16px;">Generate Report</h4>
                            <p class="intro-text" style="line-height: 1.6; font-size: 14px;">
                                After running the analysis, you'll receive a comprehensive summary that includes all your 
                                input parameters, the measurement data used, the statistical methods applied, key assumptions, 
                                and a scientific explanation of the results. This report provides the documentation needed 
                                for regulatory review and credit issuance, including the conservative estimate suitable for 
                                conservative crediting.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button type="button" onclick="beginWorkflow()" style="max-width: 300px; font-size: 18px; padding: 15px 30px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: white; background-color: #4F46E5; border: none; cursor: pointer;">
                    <span>Begin</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 20px; height: 20px; stroke-width: 2.5;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Define Scenario Tab -->
        <div id="scenario" class="tab-content">
            <h2>Define Scenario</h2>
            <p class="intro-text">
                A <strong>scenario</strong> is one specific combination of rock source, grinding size, 
                application rate, and climate. The model will estimate COâ‚‚ removal and uncertainty 
                for this scenario over 10 years. Fill in the fields below to create your scenario.
            </p>
            
            <form id="configForm">
                <div class="form-group">
                    <label>
                        Scenario Name *
                        <span class="tooltip-container">
                            <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                            <span class="tooltip-content">
                                <strong>Scenario Name</strong>
                                A human-readable label to identify this scenario. This will be automatically converted to a unique configuration ID.
                                <span class="example"><strong>Example:</strong> "Canada Fine Grind 20t/ha"</span>
                            </span>
                        </span>
                    </label>
                    <p class="field-explanation">
                        A human-readable label to identify this scenario. This will be automatically converted to a unique configuration ID. 
                        <strong>Example: "Canada Fine Grind 20t/ha"</strong>
                    </p>
                    <input type="text" id="scenario_name" required placeholder="Example: Canada Fine Grind 20t/ha">
                </div>
                
                <div class="form-group">
                    <label>
                        Deposit Name *
                        <span class="tooltip-container">
                            <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                            <span class="tooltip-content">
                                <strong>Deposit Name</strong>
                                The name or code for the rock deposit. This identifies where the rock comes from and will be automatically converted to a unique deposit ID.
                                <span class="example"><strong>Example:</strong> "Canada North Deposit Layer 3"</span>
                            </span>
                        </span>
                    </label>
                    <p class="field-explanation">
                        The name or code for the rock deposit. This identifies where the rock comes from and will be automatically 
                        converted to a unique deposit ID. <strong>Example: "Canada North Deposit Layer 3"</strong>
                    </p>
                    <input type="text" id="deposit_name" required placeholder="Example: Canada North Deposit Layer 3">
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label>
                            Rock Product Name
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>Rock Product Name</strong>
                                    Optional identifier for the rock product or blend. Helps compare different grind or mixing strategies from the same deposit.
                                    <span class="example"><strong>Example:</strong> "BASIC_MIX_01" or "Fine Grind Premium"</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Optional: Identifies the rock product or blend (e.g., "BASIC_MIX_01"). Helps compare different grind or mixing strategies.
                        </p>
                        <input type="text" id="blend_code" placeholder="e.g., BASIC_MIX_01">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Size Fraction (mm)
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>Size Fraction</strong>
                                    Median particle size (D50) in millimeters. Smaller particles weather faster because more surface area is exposed.
                                    <span class="example"><strong>Example:</strong> 0.50 mm<br><strong>Range:</strong> Typically 0.01 - 10.0 mm</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Typical particle size in millimeters. Use the D50 (median particle size) if available. 
                            Smaller particles weather faster because more surface area is exposed. 
                            <strong>Example: 0.50 mm (D50)</strong>
                        </p>
                        <input type="number" step="0.01" id="size_fraction_mm" placeholder="Example: 0.50">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Application Rate (t/ha) *
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>Application Rate</strong>
                                    Tons of rock applied per hectare. Higher application rates add more reactive material per hectare, directly affecting COâ‚‚ removal.
                                    <span class="example"><strong>Example:</strong> 20 t/ha<br><strong>Range:</strong> Typically 5 - 100 t/ha</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Tons of rock applied per hectare. Higher application rates add more reactive material per hectare, 
                            directly affecting COâ‚‚ removal.
                        </p>
                        <input type="number" step="0.1" id="application_rate_t_ha" required placeholder="e.g., 20">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            MgO (% by weight)
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>MgO Percentage</strong>
                                    Magnesium oxide percentage by weight from your assay report. Used to calculate the chemistry factor K.
                                    <span class="example"><strong>Example:</strong> 18.5%<br><strong>Range:</strong> 0 - 100%</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Magnesium oxide percentage from your assay report (0-100). Used to calculate the chemistry factor K, 
                            which determines how much COâ‚‚ the rock can theoretically store. 
                            <strong>Example: 18.5 (from assay report)</strong>
                        </p>
                        <input type="number" step="0.1" id="mgo_percent" placeholder="Example: 18.5">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            CaO (% by weight)
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>CaO Percentage</strong>
                                    Calcium oxide percentage by weight from your assay report. Used to calculate the chemistry factor K.
                                    <span class="example"><strong>Example:</strong> 9.2%<br><strong>Range:</strong> 0 - 100%</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Calcium oxide percentage from your assay report (0-100). Used to calculate the chemistry factor K. 
                            <strong>Example: 9.2</strong>
                        </p>
                        <input type="number" step="0.1" id="cao_percent" placeholder="Example: 9.2">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Chemistry Factor K (auto-calculated)
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>Chemistry Factor K</strong>
                                    Automatically calculated from MgO% and CaO% using: K = (MgO% Ã— 1.09 + CaO% Ã— 0.785) / 100. Represents the theoretical COâ‚‚ storage capacity.
                                    <span class="example"><strong>Example:</strong> 0.28 (for 18.5% MgO, 9.2% CaO)</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Automatically calculated from MgO% and CaO% using: K = (MgO% Ã— 1.09 + CaO% Ã— 0.785) / 100. 
                            This value represents the theoretical COâ‚‚ storage capacity of the rock.
                        </p>
                        <input type="number" step="0.001" id="chemistry_factor_K" readonly placeholder="Will be calculated automatically" class="readonly-input">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Climate Setting *
                            <span class="tooltip-container">
                                <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                <span class="tooltip-content">
                                    <strong>Climate Setting</strong>
                                    Climate category affects how fast weathering happens. The model uses this to adjust weathering rates based on temperature and precipitation patterns.
                                    <span class="example"><strong>Options:</strong> Cold/Wet, Temperate, Hot/Dry</span>
                                </span>
                            </span>
                        </label>
                        <p class="field-explanation">
                            Climate category affects how fast weathering happens. The model uses this to adjust weathering rates 
                            based on temperature and precipitation patterns.
                        </p>
                        <select id="climate_bucket" required>
                            <option value="">Select climate</option>
                            <option value="COLD_WET">Cold / Wet</option>
                            <option value="TEMPERATE">Temperate</option>
                            <option value="HOT_DRY">Hot / Dry</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button type="submit">Create Scenario</button>
                </div>
                <div id="configMessage" class="message"></div>
            </form>
        </div>
        
        <!-- Add Evidence Tab -->
        <div id="evidence" class="tab-content">
            <h2>Add Evidence</h2>
            <p class="intro-text">
                Here you provide the <strong>measurements</strong> that the model will learn from. 
                Simulation laboratory testing (verification testing) tells us how fast the rock reacts with COâ‚‚ under controlled conditions. 
                Soil laboratory analysis provides site-specific soil properties from deployment sites. 
                Field observation data confirm how the rock behaves in real soil and climate conditions. 
                All evidence sources feed into the uncertainty modelâ€”the more evidence you provide, 
                the more confident the model becomes.
            </p>
            
            <!-- Simulation Laboratory Testing (Verification Testing) Section -->
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>1. Simulation Laboratory Testing (Verification Testing)</h3>
                    <span class="collapsible-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content">
                    <div style="margin-bottom: 20px;">
                        <p class="intro-text" style="margin-bottom: 15px;">
                            <strong>What is simulation laboratory testing (verification testing)?</strong> These are controlled 
                            lab experiments performed by the team to verify whether the simulator's predicted COâ‚‚ uptake curves 
                            match newly observed controlled measurements. These experiments involve exposing a known mass of rock 
                            material to COâ‚‚ under controlled temperature, humidity, and atmospheric conditions. These are 
                            <strong>model verification tests</strong>, not related to soil samples or field sites.
                        </p>
                        <p class="intro-text" style="margin-bottom: 15px;">
                            The model uses these measurements to estimate the <strong>weathering rate</strong>, which 
                            represents how quickly COâ‚‚ is taken up per month per tonne of rock. This rate is a key parameter 
                            in predicting long-term COâ‚‚ removal performance in field conditions.
                        </p>
                    </div>
                    
                    <form id="labDataForm">
                        <div class="form-group">
                            <label>
                                Scenario Name *
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                    <span class="tooltip-content">
                                        <strong>Scenario Name</strong>
                                        Select the scenario name that you created in the "Define Scenario" step. The system will automatically find the associated configuration.
                                        <span class="example"><strong>Example:</strong> "Canada Fine Grind 20t/ha"</span>
                                    </span>
                                </span>
                            </label>
                            <p class="field-explanation">
                                Select the scenario name that you created in the "Define Scenario" step.
                            </p>
                            <select id="lab_scenario_select" required>
                                <option value="">-- Select Scenario --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                Simulation Laboratory Testing Data (CSV File) *
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                    <span class="tooltip-content">
                                        <strong>Simulation Laboratory Testing Data</strong>
                                        Upload CSV file containing model verification test data. These are controlled lab experiments to verify predicted COâ‚‚ uptake curves.
                                        <span class="example"><strong>Format:</strong> time_months, co2_uptake_t_per_t</span>
                                    </span>
                                </span>
                            </label>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                Upload a CSV file containing simulation laboratory testing (verification testing) data. The CSV must contain exactly TWO columns:
                            </p>
                            <ul class="field-explanation" style="font-size: 13px; margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                                <li><strong>time_months</strong> (number, required) â€“ Time since the start of the experiment, measured in months. 
                                    Example: 1.0 means 1 month, 2.5 means 2.5 months.</li>
                                <li><strong>co2_uptake_t_per_t</strong> (number, required) â€“ Cumulative COâ‚‚ taken up per tonne of rock material, 
                                    measured in tonnes COâ‚‚ per tonne of rock (t COâ‚‚ / t rock). Units: tonnes COâ‚‚ per tonne rock (tCOâ‚‚/t).</li>
                            </ul>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                <strong>Example CSV format:</strong>
                            </p>
                            <div class="json-example">
time_months,co2_uptake_t_per_t<br>
1.0,0.5<br>
2.0,0.7<br>
3.0,0.85
                            </div>
                            <input type="file" id="lab_data_file" accept=".csv" required style="padding: 8px;">
                            <p class="field-explanation" style="margin-top: 8px; color: #888; font-size: 11px;">
                                Select a CSV file with the required columns. The file will be validated before upload.
                            </p>
                        </div>
                        <button type="submit">Upload Simulation Laboratory Testing Data</button>
                        <div id="labDataMessage" class="message"></div>
                    </form>
                </div>
            </div>
            
            <!-- Soil Laboratory Analysis (Site-Specific Soil Tests) Section -->
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>2. Soil Laboratory Analysis (Site-Specific Soil Tests)</h3>
                    <span class="collapsible-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content">
                    <div style="margin-bottom: 20px;">
                        <p class="intro-text" style="margin-bottom: 15px;">
                            <strong>What is soil laboratory analysis?</strong> These are physical soil samples taken from 
                            deployment sites and analyzed in a laboratory. This data provides site-specific soil properties 
                            such as pH, cation exchange capacity (CEC), electrical conductivity (EC), bulk density, 
                            texture, mineralogy, and organic matter content. This information helps characterize the 
                            deployment environment but is not used directly in the simulation model.
                        </p>
                        <p class="intro-text" style="margin-bottom: 15px;">
                            <strong>Note:</strong> This data is stored for documentation purposes and will appear in the 
                            final report. It is not ingested into the backend simulation model.
                        </p>
                    </div>
                    
                    <form id="soilDataForm">
                        <div class="form-group">
                            <label>
                                Soil Laboratory Analysis Data (CSV File)
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                    <span class="tooltip-content">
                                        <strong>Soil Laboratory Analysis Data</strong>
                                        Upload CSV file containing soil property measurements from deployment sites. Format: soil_property, value.
                                        <span class="example"><strong>Example:</strong> pH, 7.2 or texture, sandy loam</span>
                                    </span>
                                </span>
                            </label>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                Upload a CSV file containing soil laboratory analysis data. The CSV must contain exactly TWO columns:
                            </p>
                            <ul class="field-explanation" style="font-size: 13px; margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                                <li><strong>soil_property</strong> (string, required) â€“ Name of the soil property being measured. 
                                    Examples: "pH", "CEC", "EC", "bulk_density", "texture", "mineralogy", "organic_matter"</li>
                                <li><strong>value</strong> (number or string, required) â€“ The measured value. Numeric for pH, CEC, EC, bulk_density. 
                                    String for texture, mineralogy, organic_matter.</li>
                            </ul>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                <strong>Example CSV format:</strong>
                            </p>
                            <div class="json-example">
soil_property,value<br>
pH,7.2<br>
CEC,15.5<br>
EC,0.8<br>
bulk_density,1.35<br>
texture,sandy loam<br>
organic_matter,2.5%
                            </div>
                            <input type="file" id="soil_data_file" accept=".csv" style="padding: 8px;">
                            <p class="field-explanation" style="margin-top: 8px; color: #888; font-size: 11px;">
                                Select a CSV file with the required columns. The file will be validated before processing. Duplicate soil_property entries will be rejected.
                            </p>
                        </div>
                        <button type="submit">Process Soil Laboratory Analysis Data</button>
                        <div id="soilDataMessage" class="message"></div>
                    </form>
                </div>
            </div>
            
            <!-- Field Observation Data Section -->
            <div class="collapsible-section expanded">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <h3>3. Field Observation Data</h3>
                    <span class="collapsible-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </span>
                </div>
                <div class="collapsible-content">
                    <div style="margin-bottom: 20px;">
                        <p class="intro-text" style="margin-bottom: 15px;">
                            <strong>What are field observations?</strong> Field observations capture actual COâ‚‚ removal 
                            in real deployment conditions over specific time windows (for example, 12-month periods). 
                            These measurements are typically obtained through soil sampling, gas flux measurements, or 
                            other field monitoring techniques that quantify the net COâ‚‚ removal achieved in agricultural settings.
                        </p>
                        <p class="intro-text" style="margin-bottom: 15px;">
                            Field observation data help confirm that the weathering rates estimated from simulation laboratory testing 
                            hold under real-world conditions, accounting for factors like soil chemistry, microbial activity, irrigation, 
                            and seasonal climate variations. This validation is crucial for building confidence in long-term 
                            predictions.
                        </p>
                    </div>
                    
                    <form id="fieldDataForm">
                        <div class="form-group">
                            <label>
                                Scenario Name *
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                    <span class="tooltip-content">
                                        <strong>Scenario Name</strong>
                                        Enter the scenario name that you created in the "Define Scenario" step. The system will automatically find the associated configuration.
                                        <span class="example"><strong>Example:</strong> "Canada Fine Grind 20t/ha"</span>
                                    </span>
                                </span>
                            </label>
                            <p class="field-explanation">
                                Select the scenario name that you created in the "Define Scenario" step.
                            </p>
                            <select id="field_scenario_select" required>
                                <option value="">-- Select Scenario --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                Field Observation Data (CSV File) *
                                <span class="tooltip-container">
                                    <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                                    <span class="tooltip-content">
                                        <strong>Field Observation Data</strong>
                                        Upload a CSV file containing field observation data. The CSV must contain exactly THREE columns: window_start, window_end, and co2_removed_t_ha.
                                        <span class="example"><strong>Example:</strong> See CSV format below</span>
                                    </span>
                                </span>
                            </label>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                Upload a CSV file containing field observation data. The CSV must contain exactly THREE columns:
                            </p>
                            <ul class="field-explanation" style="font-size: 13px; margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">
                                <li><strong>window_start</strong> (integer, required) â€“ Start month of the measurement window. 
                                    Example: 0 means from the start of deployment, 12 means starting at month 12.</li>
                                <li><strong>window_end</strong> (integer, required) â€“ End month of the measurement window. 
                                    Example: 12 means the window ends at month 12, 24 means it ends at month 24.</li>
                                <li><strong>co2_removed_t_ha</strong> (number, required) â€“ Total COâ‚‚ removed per hectare during 
                                    this time window, measured in tonnes COâ‚‚ per hectare (t COâ‚‚ / ha). Units: tonnes COâ‚‚ per hectare (tCOâ‚‚/ha).</li>
                            </ul>
                            <p class="field-explanation" style="margin-bottom: 10px;">
                                <strong>Example CSV format:</strong>
                            </p>
                            <div class="json-example">
window_start,window_end,co2_removed_t_ha<br>
0,12,10.5<br>
12,24,15.2
                            </div>
                            <input type="file" id="field_data_file" accept=".csv" required style="padding: 8px;">
                            <p class="field-explanation" style="margin-top: 8px; color: #888; font-size: 11px;">
                                Select a CSV file with the required columns. The file will be validated before upload.
                            </p>
                        </div>
                        <button type="submit">Upload Field Observation Data</button>
                        <div id="fieldDataMessage" class="message"></div>
                    </form>
                </div>
            </div>
            
        </div>
        
        <!-- Run Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2>Run Analysis</h2>
            
            <!-- Narrative Explanation -->
            <div class="model-explanation-box">
                <h3>How the Model Works</h3>
                
                <div style="margin-bottom: 20px;">
                    <p class="intro-text" style="margin-bottom: 12px;">
                        <strong>What happens when you run the analysis?</strong> The simulator combines your scenario definition 
                        (rock chemistry, particle size, application rate, climate) with all available evidence (laboratory testing 
                        and field measurements) to estimate how much COâ‚‚ will be removed over 10 years. The process involves three 
                        main steps:
                    </p>
                    <ol>
                        <li><strong>Update Model State:</strong> The system uses an Extended Kalman Filter to fit the model parameters 
                            to your laboratory and field data, estimating the weathering rate and its uncertainty.</li>
                        <li><strong>Run Simulations:</strong> Thousands of Monte Carlo simulations project forward 10 years, accounting 
                            for uncertainty in weathering rates and potential risks.</li>
                        <li><strong>Calculate Results:</strong> The distribution of outcomes is summarized into key statistics, including 
                            a conservative estimate suitable for carbon credit issuance.</li>
                    </ol>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p class="intro-text" style="margin-bottom: 12px;">
                        <strong>How do simulation laboratory testing and field data feed the model?</strong> Simulation laboratory 
                        testing (verification testing) data provide controlled measurements of how fast the rock reacts with COâ‚‚ under 
                        ideal conditions. Field observation data show how the rock performs in real agricultural settings. The model 
                        uses both data sources together: simulation laboratory testing data help estimate the base weathering rate, 
                        while field observation data help validate and adjust for real-world conditions. The more evidence you provide, 
                        the more confident the model becomes about its predictions.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p class="intro-text" style="margin-bottom: 12px;">
                        <strong>How is uncertainty calculated?</strong> Uncertainty comes from multiple sources: measurement error in 
                        your simulation laboratory testing and field observation data, natural variability in weathering rates, and uncertainty 
                        about future conditions (climate, soil chemistry, etc.). The model uses Bayesian statistics to combine all these 
                        sources of uncertainty into a probability distribution. This distribution tells us not just the expected COâ‚‚ removal, 
                        but also how confident we can be about that estimate.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p class="intro-text" style="margin-bottom: 12px;">
                        <strong>Why monthly steps and Markov structure?</strong> The model simulates COâ‚‚ removal month by month over 
                        10 years (120 months). This monthly structure allows the model to capture seasonal variations in weathering rates 
                        (which depend on temperature, rainfall, and soil moisture). The Markov structure means that each month's state 
                        depends on the previous month's state plus some random variationâ€”this captures how weathering is a cumulative 
                        process that builds over time.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p class="intro-text" style="margin-bottom: 12px;">
                        <strong>Why Monte Carlo simulation?</strong> Monte Carlo simulation runs the model thousands of times, each time 
                        sampling different values from the uncertainty distributions. This gives us a full picture of possible outcomes: 
                        some runs show high COâ‚‚ removal, some show low removal, and most cluster around the expected value. By running 
                        many simulations, we can calculate percentiles (like the 5th percentile) that represent conservative estimates 
                        with known confidence levels.
                    </p>
                </div>
                
                <div>
                    <p class="intro-text" style="margin-bottom: 0;">
                        <strong>Why the 5th percentile as the conservative value?</strong> The 5th percentile means that 95% of all 
                        simulated outcomes show COâ‚‚ removal at or above this value. In other words, we are 95% confident that actual 
                        COâ‚‚ removal will be at least this amount. This conservative approach is standard for carbon credit issuance 
                        because it ensures credits are only issued for COâ‚‚ removal we can be highly confident about, protecting 
                        against over-crediting.
                    </p>
                </div>
            </div>
            
            <!-- Analysis Form -->
            <form id="analysisForm">
                <div class="form-group">
                    <label>
                        Scenario Name *
                        <span class="tooltip-container">
                            <span class="tooltip-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                            <span class="tooltip-content">
                                <strong>Scenario Name</strong>
                                Enter the scenario name that you created in the "Define Scenario" step. The system will automatically find the associated configuration.
                                <span class="example"><strong>Example:</strong> "Canada Fine Grind 20t/ha"</span>
                            </span>
                        </span>
                    </label>
                    <p class="field-explanation">
                        Select the scenario name that you created in the "Define Scenario" step.
                    </p>
                    <select id="analysis_scenario_select" required>
                        <option value="">-- Select a scenario --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Number of Simulation Runs *</label>
                    <p class="field-explanation">
                        Number of Monte Carlo simulation runs to perform. More runs provide better statistical accuracy 
                        but take longer. Recommended: 100-1000 runs.
                    </p>
                    <input type="number" id="n_runs" value="100" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>Risk Profile (Optional)</label>
                    <p class="field-explanation">
                        Optional risk profile ID to apply discrete risks (drought, misapplication, etc.) during simulation.
                    </p>
                    <input type="text" id="risk_profile" placeholder="Leave empty if not using risk profiles">
                </div>
                
                <button type="submit" id="runAnalysisBtn" style="background: #4F46E5; color: white; border: none;">Run Full Analysis</button>
                <div id="analysisMessage" class="message"></div>
            </form>
            
            <!-- Results Display -->
            <div id="analysisResults" class="results"></div>
        </div>
        
        <!-- Generate Report Tab -->
        <div id="report" class="tab-content">
            <h2>Generate Report</h2>
            <p class="intro-text">
                Generate a comprehensive narrative report that documents your scenario definition, all evidence data, 
                the statistical modeling approach, and simulation results. This report provides the documentation needed 
                for regulatory review and carbon credit issuance.
            </p>
            
            <div style="margin-bottom: 20px;">
                <button type="button" id="generateReportBtn" onclick="generateReport()" style="max-width: 300px; margin-bottom: 15px;">
                    Generate Report Text
                </button>
                <button type="button" id="downloadReportBtn" onclick="downloadReport()" style="max-width: 300px; background: #28a745;" disabled>
                    Download Report (.txt)
                </button>
            </div>
            
            <div class="form-group">
                <label>Report Content</label>
                <p class="field-explanation">
                    The generated report will appear below. Review the content, then click "Download Report (.txt)" to save it.
                </p>
                <textarea id="reportTextarea" rows="30" readonly style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;" placeholder="Report sections will include:

â€¢ Regulatory Narrative
  A comprehensive explanation of the modeling approach, evidence types, and statistical methods used.

â€¢ Mathematical Model Explanation
  Detailed description of Bayesian updating, Markov state transitions, and Monte Carlo simulation.

â€¢ Scenario Input Summary
  All scenario parameters including deposit name, rock chemistry, particle size, application rate, and climate setting.

â€¢ Simulation Laboratory Testing Data Summary
  Controlled laboratory experiments used to verify the simulator's predicted COâ‚‚ uptake curves.

â€¢ Soil Laboratory Analysis Summary
  Site-specific soil properties such as pH, CEC, texture, and mineralogy from deployment sites.

â€¢ Field Observation Data Summary
  Actual COâ‚‚ removal measurements from real deployment conditions over defined time windows.

â€¢ Simulation Results Interpretation
  Statistical summaries including mean, median, 5th percentile (conservative), and 95th percentile COâ‚‚ removal estimates.

â€¢ Closing Statement
  Summary of all inputs, evidence, and modeled outputs used for the 10-year COâ‚‚ retention forecast.

Click 'Generate Report Text' to create the full report with all your scenario data and simulation results."></textarea>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button type="button" onclick="restartSimulation()" style="max-width: 300px; background: #28a745;">
                    Run Another Simulation
                </button>
            </div>
        </div>
        
        <!-- Technical Rationale Tab -->
        <div id="technical" class="tab-content">
            <h2>Technical Rationale</h2>
            <p class="intro-text" style="margin-bottom: 24px;">
                This section provides detailed technical documentation covering input data formats, simulation workflows, 
                evidence integration methods, calculations performed, and report generation processes.
            </p>
            <div id="technicalContent" class="report-content-box" style="max-height: 70vh; overflow-y: auto; overflow-x: hidden;">
                <p class="intro-text" style="font-style: italic; color: var(--text-muted);">Loading technical documentation...</p>
            </div>
        </div>
        </div>
    </div>
    
    <script>
        // API Base URL - Define first to avoid initialization errors
        const API_BASE = window.location.origin;
        
        // Dark Mode Functionality
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                updateDarkModeToggle(true);
            } else {
                document.body.classList.remove('dark-mode');
                updateDarkModeToggle(false);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            updateDarkModeToggle(isDark);
        }
        
        function updateDarkModeToggle(isDark) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const darkModeText = document.getElementById('darkModeText');
            
            if (isDark) {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
                darkModeText.textContent = 'Light Mode';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
                darkModeText.textContent = 'Dark Mode';
            }
        }
        
        // Initialize dark mode on page load
        initDarkMode();
        
        // Enhanced fetch with timeout and retry logic
        const DEFAULT_TIMEOUT = 30000; // 30 seconds
        const MAX_RETRIES = 3;
        const INITIAL_RETRY_DELAY = 1000; // 1 second
        
        /**
         * Fetch with timeout using AbortController
         * @param {string} url - Request URL
         * @param {Object} options - Fetch options
         * @param {number} timeout - Timeout in milliseconds (default: 30000)
         * @returns {Promise<Response>}
         */
        async function fetchWithTimeout(url, options = {}, timeout = DEFAULT_TIMEOUT) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Request timeout after ${timeout}ms`);
                }
                throw error;
            }
        }
        
        /**
         * Fetch with retry logic and exponential backoff
         * @param {string} url - Request URL
         * @param {Object} options - Fetch options
         * @param {number} maxRetries - Maximum number of retries (default: 3)
         * @param {number} initialDelay - Initial retry delay in ms (default: 1000)
         * @param {number} timeout - Request timeout in ms (default: 30000)
         * @returns {Promise<Response>}
         */
        async function fetchWithRetry(url, options = {}, maxRetries = MAX_RETRIES, initialDelay = INITIAL_RETRY_DELAY, timeout = DEFAULT_TIMEOUT) {
            let lastError;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetchWithTimeout(url, options, timeout);
                    
                    // If response is OK, return it immediately
                    if (response.ok) {
                        return response;
                    }
                    
                    // For 4xx client errors, return immediately (don't retry)
                    if (response.status >= 400 && response.status < 500) {
                        return response;
                    }
                    
                    // For 5xx server errors, throw to trigger retry
                    if (response.status >= 500) {
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }
                    
                    // For other status codes, return the response
                    return response;
                } catch (error) {
                    lastError = error;
                    
                    // Don't retry on last attempt
                    if (attempt === maxRetries) {
                        break;
                    }
                    
                    // Calculate exponential backoff delay
                    const delay = initialDelay * Math.pow(2, attempt);
                    
                    // Log retry attempt (optional, can be removed in production)
                    console.warn(`Request failed (attempt ${attempt + 1}/${maxRetries + 1}), retrying in ${delay}ms...`, error.message);
                    
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            // All retries exhausted
            throw lastError;
        }
        
        // Store generated IDs for lookup
        const scenarioNameToConfigId = {};
        const depositNameToDepositId = {};
        
        // FULL NARRATIVE - Parts 1-4
        const FULL_NARRATIVE = `

COâ‚‚ RETENTION SIMULATOR â€“ REGULATORY NARRATIVE

==============================================



Introduction



This document describes the method used to estimate long term carbon dioxide removal through enhanced rock weathering and to quantify the uncertainty associated with that estimate. The objective is to provide regulators and scientific reviewers with a clear, traceable explanation of how evidence is collected, how it is interpreted by the model, which assumptions are applied, and how the final creditable amount of COâ‚‚ removal is derived. The description is written in plain language so that readers without a background in Bayesian statistics or stochastic modeling can follow the reasoning, while still preserving the underlying technical structure.



Enhanced rock weathering relies on naturally occurring geochemical reactions, where magnesium and calcium bearing minerals dissolve in the presence of moisture and carbon dioxide and form dissolved or solid carbonate species. The rate at which this happens depends on the chemistry of the rock, the particle size distribution, the soil environment, and climate factors such as temperature and rainfall. These conditions change over time. The model therefore treats carbon removal as a time evolving process, accumulated month by month over a ten year horizon, rather than as a single static number. The ten year period aligns with regulatory expectations for assessing durability and matches the period during which most of the modeled weathering is expected to occur after application.



Two distinct types of evidence are involved in this workflow. First, there is simulation laboratory testing, which consists of controlled experiments on rock material used to verify or validate the simulator's projected COâ‚‚ uptake curves. Second, there is soil laboratory analysis, which consists of laboratory analysis of soil samples taken from deployment sites to understand the environmental and chemical context in which the rock is deployed. In addition, there are direct field measurements of COâ‚‚ removal. These three evidence streams serve different roles and are treated separately in the model and in this narrative.



The following sections describe in order how scenarios are defined, how evidence is incorporated, how the statistical model is structured, how simulations are performed, and how results are interpreted for conservative crediting.



Scenario definition



A scenario represents one specific combination of rock source, particle size, application rate, chemistry and climate setting. This is necessary because different materials and different deposits behave differently, even when they are classified under the same general mineralogical category. For example, two deposits with similar reported magnesium oxide and calcium oxide percentages may show different weathering behavior due to differences in purity, grain size distribution, inclusion content or prior alteration. Scenario definition makes these differences explicit so that evidence is not mixed across incompatible materials or conditions.



Each scenario starts with a human readable scenario name and a deposit name, which are converted to internal identifiers. The deposit name links the analysis to a specific geological source. The rock product name or blend code can be used to distinguish different grinds or blends from the same deposit. Particle size is recorded as a characteristic metric such as D50 in millimetres. Finer material exposes more surface area to chemical reaction and therefore can weather faster than coarser fractions. Application rate in tonnes per hectare determines how much reactive material is applied to a given area; a higher application rate increases the absolute COâ‚‚ removal potential on that area for a given rate of weathering.



Material chemistry is captured via magnesium oxide and calcium oxide percentages by weight from assay data. These values are combined into a single effective chemistry factor K, using a fixed linear formula, to represent the theoretical COâ‚‚ storage capacity of the rock per tonne applied. This avoids requiring users to perform separate stoichiometric calculations while keeping the relationship between chemistry and COâ‚‚ capacity consistent across scenarios. A climate setting is selected from a small set of categories such as cold wet, temperate or hot dry. This category reflects the broad climatic regime that influences temperature and moisture patterns, and therefore the expected seasonal progression of weathering.



The scenario definition does not itself produce a COâ‚‚ removal estimate. It provides the structured context into which evidence is later added. Without this structure, it would not be possible to interpret simulation outputs in a way that is specific enough for regulatory assessment.



Simulation laboratory testing



Simulation laboratory testing consists of controlled experiments in which rock material is exposed to COâ‚‚ under well defined conditions and the cumulative uptake is measured over time. These experiments are not intended to reproduce the full complexity of soil systems. Instead, they provide direct measurements of intrinsic weathering behavior under stable and repeatable exposure. The primary output is a series of points showing cumulative COâ‚‚ uptake per tonne of rock as a function of time in months.



The model interprets this data as evidence about the underlying weathering rate. It does not treat these measurements as final performance outcomes. Early time points indicate how quickly the material begins to react, while later time points indicate whether uptake curves are continuing to rise or beginning to flatten. These patterns inform the latent monthly reaction rate that the model later uses in long term projections.



There are tradeoffs. Laboratory conditions usually hold temperature and moisture constant within a narrow band, and they do not include field scale factors such as soil structure or plant root dynamics. Still, they provide clean evidence that is not confounded by operational variability. Without simulation laboratory testing, the model would be forced to infer the weathering rate solely from field evidence, which is often sparser and more variable.



Field measurements



Field measurements capture the COâ‚‚ removal achieved under actual deployment conditions over defined time windows. These measurements may be derived from soil carbon sampling, gas flux measurement or other monitoring methods applied over, for example, twelve month windows. They reflect the combined effects of rock properties, soil environment, microbial processes, climate variability and management practices.



The model uses field measurements as confirmation data. They show how the material performs in real conditions and are used to adjust the latent weathering rate estimated from simulation laboratory testing. In some cases field results will align closely with laboratory expectations. In other cases they will deviate due to site specific factors such as drier conditions or different soil chemistry. When deviations occur, the model does not treat them as errors that must be discarded. They are used to update the state of the underlying variables so that future projections are anchored in what is observed in the field.



Field data are often less regular than laboratory data. Sampling windows may change over time and not all deployments will have the same intensity of monitoring. The Bayesian update step accounts for this by weighting each observation according to its uncertainty. Observations with clearer signals and better measurement quality have more influence on the updated state. Observations with higher uncertainty still contribute but do so more cautiously, preventing noisy data from causing abrupt or unrealistic shifts.



Soil laboratory analysis



Soil laboratory analysis consists of measurements on soil samples taken from deployment sites and processed in a laboratory to determine properties such as pH, cation exchange capacity, texture, mineralogical composition and related indicators. These tests do not directly measure COâ‚‚ removal. Instead, they describe the environment in which weathering occurs and provide context for interpreting field measurements.



For example, soil pH can influence the speciation of dissolved carbon, and texture can influence water holding capacity and gas diffusion. Soil laboratory analysis helps explain why a particular site exhibits higher or lower field measured COâ‚‚ removal than expected from simulation laboratory testing alone. In this version of the system, soil analysis is treated as contextual evidence stored alongside the scenario and field data. It supports interpretation and future model refinement rather than driving the core simulation itself.



Model validation using simulation laboratory testing



Simulation laboratory testing can also be used later in the project life cycle to validate the model's predictions. Once the model has been calibrated using an initial set of laboratory and field data, additional controlled experiments can be run on the same or related material. The resulting uptake curves can then be compared to the trajectories the model would have predicted for those conditions. When the predicted and observed behavior align reasonably well, confidence in the model's structure and parameterization increases. When they diverge, the divergence can point to areas where assumptions may need adjustment or where additional data are needed.



In the current version, this validation role is described in the narrative and the user interface but is not yet fully wired into the automated backend ingestion. It remains a documented part of the intended MRV quality assurance process and can be integrated as additional evidence streams in future iterations.



Statistical model structure



The core of the model uses latent variables to represent quantities that cannot be measured directly but can be inferred from evidence. Two such latent variables are central in this version. The first is the intrinsic weathering rate, expressed as a monthly rate of COâ‚‚ uptake per tonne of rock. The second is a retention factor, which describes the fraction of reacted COâ‚‚ that remains stored over the long term, after accounting for any losses or reversals that are within the modeled scope.



These latent variables evolve through time according to a Markov structure. In practice this means that the state of the system at a given month depends on the previous month's state plus process noise, and not on the full history of states before that. Evidence collected at different times is used to update the state as it moves forward, but once an update has occurred the model does not reopen past states. This preserves forward consistency and prevents data from one deposit or environment from implicitly affecting another.



Bayesian updating is used to combine prior expectations with new evidence from simulation laboratory testing, field measurements and, where available, additional verification tests. Each new piece of evidence leads to an updated distribution for the latent variables rather than a single point estimate. When evidence is strong and precise, the updated distribution becomes narrower, meaning uncertainty is reduced. When evidence is weak or noisy, the updated distribution remains broader, meaning the model acknowledges that more than one value of the latent variables is consistent with the data.



Monthly Markov transitions propagate these distributions forward over the ten year horizon. Each month the model advances the state using the current distribution and the transition rules, carrying uncertainty along with it. This produces a distribution of possible outcomes for total COâ‚‚ removal rather than a single expected value.



Monte Carlo simulation



Monte Carlo simulation is used to sample from the distributions produced by the Bayesian and Markov structure to characterize the range of possible future outcomes. Instead of calculating only a mean trajectory, the system runs many simulated futures, each one representing one plausible sequence of monthly weathering and retention over the ten year horizon.



In each run, the model draws values of the latent weathering rate and retention factor consistent with their current uncertainty and then advances them month by month. Some runs will show higher than average outcomes; some will show lower outcomes; most will cluster around a central tendency. When a risk profile is specified, discrete risks such as drought or misapplication are applied according to that profile. These events alter the trajectory in those runs where they occur but do so within defined bounds so that risk effects are represented without dominating the underlying geochemical signal.



The number of Monte Carlo runs is configurable, with a tradeoff between computational cost and the smoothness of the resulting distribution. A small number of runs yields faster but noisier estimates of percentiles; a larger number yields more stable percentile estimates at the cost of longer runtime. The typical range used in this context is sufficient to give a stable picture of the main percentiles of interest.



Conservative estimate and crediting logic



At the end of the Monte Carlo process, the model has a distribution of total COâ‚‚ removal for the scenario over the ten year period. From this distribution, several summary statistics are computed, including the mean, the median, the 95th percentile and the 5th percentile. The mean represents the average across all simulated futures and provides a measure of central expectation. The median indicates the value in the middle of the distribution. The 95th percentile describes the upper range of outcomes under favorable trajectories.



For crediting purposes, the key statistic is the 5th percentile. This value is interpreted as a conservative lower bound, in the sense that ninety five percent of all simulated outcomes lie at or above it. When the model is properly calibrated and the evidence has been incorporated as described above, this value can be used as the creditable COâ‚‚ removal amount with high confidence that actual performance will meet or exceed it in most cases. This approach avoids over crediting in the presence of uncertainty and aligns with regulatory expectations that conservative adjustments be applied when residual uncertainty remains.



Assumptions and boundary conditions



The model operates under a set of assumptions and boundary conditions that are made explicit for review. First, the time step is monthly and the horizon is ten years. This matches the resolution of available early time laboratory data, allows representation of seasonal patterns in weathering and aligns with the timeframe over which most of the modeled weathering is expected to occur. Shorter time steps would imply a level of detail not supported by the evidence; longer time steps would smooth out seasonality that can be relevant in some climates.



Second, the climate setting is treated as a fixed category for the duration of the simulation. It is not driven by monthly weather data in this version. This reflects the current design scope and available inputs. The climate category adjusts weathering behavior at a high level but does not attempt to represent fine scale inter annual variability.



Third, the chemistry factor K is held constant for the scenario. K depends only on the MgO and CaO content of the rock, which do not change over the life of the deployment. While more complex multi phase chemistry models are possible, the evidence and project scope support using a single effective factor for Version 1.



Fourth, material exposure is assumed to remain within the soil system and not be removed by processes outside the modeled scope. To the extent that erosion or other loss processes are expected to be material at a specific site, those effects are addressed through risk profiles and conservative use of empirical field measurements rather than explicit physical modeling at this stage.



Results summary and interpretation



The model's outputs are best understood as a distribution of possible ten year COâ‚‚ removal outcomes rather than a single number. The mean and median describe the central part of this distribution. The 5th percentile provides the conservative creditable value. The 95th percentile shows the optimistic upper end of outcomes consistent with the current evidence.



When interpreting these results, it is important to remember that they depend on the quality and quantity of evidence provided. As more simulation laboratory testing, soil laboratory analysis and field measurements are added, the uncertainty in the underlying latent variables can shrink, and the distribution of outcomes may tighten. In some cases the conservative estimate may increase as the model becomes more confident that performance is stable. In other cases the conservative estimate may decrease if new evidence indicates lower performance than initially expected. Such changes reflect the model's role as an evidence driven tool rather than a fixed lookup.



Full integration of scenario inputs, evidence and simulation outputs



The workflow integrates scenario definition, simulation laboratory testing, soil laboratory analysis, field measurements and stochastic modeling into a single coherent process. Scenario inputs establish the context. Simulation laboratory testing defines intrinsic weathering behavior under controlled conditions. Soil laboratory analysis describes the deployment environment. Field measurements confirm performance in real conditions. Bayesian updates and Markov transitions convert these data into evolving latent states, and Monte Carlo simulation translates those latent states into a distribution of long term COâ‚‚ removal outcomes.



The final reported values, especially the 5th percentile used for credit issuance, are therefore not arbitrary adjustments but the result of a structured process that combines all available evidence with clearly stated assumptions and boundary conditions. This document, together with the scenario and data summaries produced by the system, is intended to give reviewers a transparent, reproducible view of that process.

`;
        
        // Store data for report generation
        const reportData = {
            scenario: null,
            labData: null,
            soilAnalysis: null,
            fieldData: null,
            analysisResults: null
        };
        
        // Begin workflow - hide landing page, show step navigation
        function beginWorkflow() {
            document.getElementById('start-here').classList.remove('active');
            showStep('scenario');
        }
        
        // Step navigation management
        function showStep(stepName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Update step buttons
            document.querySelectorAll('.step-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected step
            document.getElementById(stepName).classList.add('active');
            
            // Highlight active step button
            const stepButtons = document.querySelectorAll('.step-button');
            const stepMap = { 'scenario': 0, 'evidence': 1, 'analysis': 2, 'report': 3 };
            if (stepMap[stepName] !== undefined) {
                stepButtons[stepMap[stepName]].classList.add('active');
            }
        }
        
        // Show Main Page
        function showMainPage() {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show landing page
            const startHere = document.getElementById('start-here');
            if (startHere) {
                startHere.classList.add('active');
            }
            
            // Hide step navigation
            const stepNav = document.getElementById('step-nav');
            if (stepNav) {
                stepNav.style.display = 'none';
            }
            
            // Update step buttons
            document.querySelectorAll('.step-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // Show Technical Rationale
        function showTechnicalRationale() {
            // Hide landing page if visible
            const startHere = document.getElementById('start-here');
            if (startHere) {
                startHere.classList.remove('active');
            }
            
            // Show step navigation if hidden
            const stepNav = document.getElementById('step-nav');
            if (stepNav) {
                stepNav.style.display = 'flex';
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show technical rationale tab
            const technicalTab = document.getElementById('technical');
            if (technicalTab) {
                technicalTab.classList.add('active');
                // Load technical documentation
                loadTechnicalDocumentation();
            }
        }
        
        // Load Technical Documentation
        async function loadTechnicalDocumentation() {
            const contentDiv = document.getElementById('technicalContent');
            
            if (!contentDiv) {
                console.error('Technical content div not found');
                return;
            }
            
            try {
                const response = await fetchWithRetry(`${API_BASE}/technical-documentation`);
                
                if (response.ok) {
                    const markdown = await response.text();
                    if (markdown && markdown.trim().length > 0) {
                        // Simple markdown to HTML conversion (basic)
                        const html = convertMarkdownToHTML(markdown);
                        contentDiv.innerHTML = html;
                    } else {
                        contentDiv.innerHTML = '<p class="error-message">Technical documentation file is empty.</p>';
                    }
                } else {
                    let errorMessage = 'Error loading technical documentation. Please ensure the file exists.';
                    try {
                        // Clone the response to read it without consuming the original
                        const responseClone = response.clone();
                        const contentType = response.headers.get('content-type') || '';
                        
                        if (contentType.includes('application/json')) {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorData.error || errorData.message || errorMessage;
                        } else {
                            const text = await responseClone.text();
                            // Try to parse as JSON if it looks like JSON
                            if (text && text.trim().startsWith('{')) {
                                try {
                                    const errorData = JSON.parse(text);
                                    errorMessage = errorData.detail || errorData.error || errorData.message || errorMessage;
                                } catch (e) {
                                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                                }
                            } else if (text && text.trim()) {
                                errorMessage = text.trim();
                            } else {
                                errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    contentDiv.innerHTML = `<p class="error-message">${errorMessage}</p>`;
                }
            } catch (error) {
                let errorMessage = 'Error loading technical documentation';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                contentDiv.innerHTML = `<p class="error-message">${errorMessage}</p>`;
            }
        }
        
        // Basic Markdown to HTML converter with dark mode support
        function convertMarkdownToHTML(markdown) {
            let html = markdown;
            
            // Headers (using CSS classes for dark mode support)
            html = html.replace(/^### (.*$)/gim, '<h3 class="tech-doc-h3">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="tech-doc-h2">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="tech-doc-h1">$1</h1>');
            
            // Code blocks (triple backticks) - process before paragraphs to avoid conflicts
            html = html.replace(/```([\s\S]*?)```/g, '<pre class="tech-doc-code-block"><code>$1</code></pre>');
            
            // Process lists (ordered and unordered) - before paragraph processing
            const lines = html.split('\n');
            let inList = false;
            let listType = '';
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const orderedMatch = line.match(/^(\d+)\.\s+(.+)$/);
                const unorderedMatch = line.match(/^[-*]\s+(.+)$/);
                
                if (orderedMatch) {
                    if (!inList || listType !== 'ol') {
                        if (inList) {
                            processedLines.push(`</${listType}>`);
                        }
                        processedLines.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    processedLines.push(`<li>${orderedMatch[2]}</li>`);
                } else if (unorderedMatch) {
                    if (!inList || listType !== 'ul') {
                        if (inList) {
                            processedLines.push(`</${listType}>`);
                        }
                        processedLines.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    processedLines.push(`<li>${unorderedMatch[1]}</li>`);
                } else {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                        inList = false;
                        listType = '';
                    }
                    processedLines.push(lines[i]);
                }
            }
            
            if (inList) {
                processedLines.push(`</${listType}>`);
            }
            
            html = processedLines.join('\n');
            
            // Paragraphs (double newlines) - using CSS class, but skip if already in a list or code block
            html = html.split('\n\n').map(para => {
                para = para.trim();
                if (para && !para.startsWith('<') && !para.match(/^<[ou]l>/) && !para.match(/^<\/[ou]l>/) && !para.match(/^<li>/) && !para.match(/^<\/li>/) && !para.match(/^<pre/) && !para.match(/^<\/pre>/)) {
                    return '<p class="tech-doc-p">' + para + '</p>';
                }
                return para;
            }).join('\n');
            
            // Inline code - using CSS class (after processing other elements)
            html = html.replace(/`([^`]+)`/g, '<code class="tech-doc-code-inline">$1</code>');
            
            // Bold (process before italic to avoid conflicts)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic (only single asterisks that aren't part of bold)
            // Replace bold markers with a temporary marker first
            html = html.replace(/\*\*/g, '___BOLD_MARKER___');
            html = html.replace(/\*([^*\n]+?)\*/g, '<em>$1</em>');
            html = html.replace(/___BOLD_MARKER___/g, '**');
            // Now process bold again
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            return html;
        }
        
        // Tab management (legacy, kept for compatibility)
        function showTab(tabName) {
            showStep(tabName);
        }
        
        // Collapsible section toggle
        function toggleCollapsible(header) {
            const section = header.closest('.collapsible-section');
            section.classList.toggle('expanded');
        }
        
        // Enhanced CSV parsing helper function with better edge case handling
        function parseCSV(text) {
            // Normalize line endings (handle CRLF, LF, CR)
            const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalized.trim().split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header row and one data row');
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            
            if (headers.length === 0 || headers.some(h => !h)) {
                throw new Error('CSV header row is invalid or contains empty column names');
            }
            
            return lines.slice(1).map((line, index) => {
                const cols = line.split(',');
                
                if (cols.length !== headers.length) {
                    throw new Error(`Row ${index + 2} has ${cols.length} columns but expected ${headers.length} columns`);
                }
                
                const obj = {};
                headers.forEach((h, i) => {
                    const value = cols[i]?.trim();
                    if (!value) {
                        throw new Error(`Row ${index + 2}, column "${h}" is empty`);
                    }
                    // Try to parse as number, keep as string if it fails
                    const numValue = parseFloat(value);
                    obj[h] = isNaN(numValue) ? value : numValue;
                });
                return obj;
            });
        }
        
        // Validate CSV columns
        function validateCSVColumns(data, requiredColumns) {
            if (data.length === 0) {
                throw new Error('CSV file is empty');
            }
            const headers = Object.keys(data[0]);
            const missing = requiredColumns.filter(col => !headers.includes(col));
            if (missing.length > 0) {
                throw new Error(`Missing required columns: ${missing.join(', ')}`);
            }
            return true;
        }
        
        // Parse Soil CSV
        function parseSoilCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header row and one data row');
            }
            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const cols = line.split(',').map(c => c.trim());
                return {
                    soil_property: cols[headers.indexOf('soil_property')],
                    value: cols[headers.indexOf('value')]
                };
            });
            return data;
        }
        
        // Validate Soil Data
        function validateSoilData(records) {
            if (records.length === 0) {
                throw new Error('Soil data CSV is empty');
            }
            
            // Check for required columns
            const firstRecord = records[0];
            if (!firstRecord.hasOwnProperty('soil_property') || !firstRecord.hasOwnProperty('value')) {
                throw new Error('CSV must contain soil_property and value columns');
            }
            
            // Reject empty rows
            const validRecords = records.filter(r => r.soil_property && r.value);
            if (validRecords.length === 0) {
                throw new Error('No valid data rows found (all rows are empty)');
            }
            
            // Check for duplicate soil_property entries
            const properties = validRecords.map(r => r.soil_property.toLowerCase());
            const duplicates = properties.filter((p, i) => properties.indexOf(p) !== i);
            if (duplicates.length > 0) {
                throw new Error(`Duplicate soil_property entries found: ${[...new Set(duplicates)].join(', ')}`);
            }
            
            // Convert numeric values for specific properties
            const numericProperties = ['pH', 'CEC', 'EC', 'bulk_density'];
            validRecords.forEach(record => {
                const prop = record.soil_property;
                if (numericProperties.includes(prop)) {
                    const numValue = parseFloat(record.value);
                    if (isNaN(numValue)) {
                        throw new Error(`Property "${prop}" must have a numeric value, got: ${record.value}`);
                    }
                    record.value = numValue;
                }
            });
            
            return validRecords;
        }
        
        // Utility function for showing messages
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${isError ? 'error' : 'success'} show`;
            setTimeout(() => {
                element.classList.remove('show');
            }, 5000);
        }
        
        // Update scenario dropdowns
        function updateScenarioDropdowns() {
            const scenarioNames = Object.keys(scenarioNameToConfigId);
            const selects = ['lab_scenario_select', 'field_scenario_select', 'analysis_scenario_select'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options except the first one
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // Add scenario names
                    scenarioNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Generate config_id from scenario name
        function generateConfigId(scenarioName) {
            // Convert to lowercase, replace all spaces with underscores
            let id = scenarioName.toLowerCase().replace(/\s+/g, '_');
            // Remove any remaining special characters except underscores
            id = id.replace(/[^a-z0-9_]/g, '');
            // Remove leading/trailing underscores
            id = id.replace(/^_+|_+$/g, '');
            return id;
        }
        
        // Generate deposit_id from deposit name
        function generateDepositId(depositName) {
            // Convert to uppercase, replace all spaces with underscores
            let id = depositName.toUpperCase().replace(/\s+/g, '_');
            // Remove any remaining special characters except underscores
            id = id.replace(/[^A-Z0-9_]/g, '');
            // Remove leading/trailing underscores
            id = id.replace(/^_+|_+$/g, '');
            
            // Check if we've seen this deposit name before
            if (!depositNameToDepositId[depositName]) {
                depositNameToDepositId[depositName] = id;
            }
            return depositNameToDepositId[depositName];
        }
        
        // Auto-calculate chemistry_factor_K
        function calculateChemistryFactor() {
            const mgo = parseFloat(document.getElementById('mgo_percent').value) || 0;
            const cao = parseFloat(document.getElementById('cao_percent').value) || 0;
            const K = (mgo * 1.09 + cao * 0.785) / 100;
            document.getElementById('chemistry_factor_K').value = K.toFixed(4);
        }
        
        // Listen for MgO and CaO changes
        document.getElementById('mgo_percent').addEventListener('input', calculateChemistryFactor);
        document.getElementById('cao_percent').addEventListener('input', calculateChemistryFactor);
        
        // Configuration Form - Define Scenario
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const scenarioName = document.getElementById('scenario_name').value;
            const depositName = document.getElementById('deposit_name').value;
            
            // Generate IDs
            const configId = generateConfigId(scenarioName);
            const depositId = generateDepositId(depositName);
            
            // Store mapping for later lookup
            scenarioNameToConfigId[scenarioName] = configId;
            
            const data = {
                config_id: configId,
                deposit_id: depositId,
                blend_code: document.getElementById('blend_code').value || null,
                size_fraction_mm: parseFloat(document.getElementById('size_fraction_mm').value) || null,
                application_rate_t_ha: parseFloat(document.getElementById('application_rate_t_ha').value),
                chemistry_factor_K: parseFloat(document.getElementById('chemistry_factor_K').value) || null,
                climate_bucket: document.getElementById('climate_bucket').value,
                is_candidate: false  // Set to false by default, removed from UI
            };
            
            try {
                const response = await fetchWithRetry(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    let errorMessage = 'Error creating scenario';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    showMessage('configMessage', errorMessage, true);
                    return;
                }
                
                const result = await response.json();
                if (result.status === 'success') {
                    showMessage('configMessage', `Scenario "${scenarioName}" created successfully!`, false);
                    
                    // Store scenario data for report
                    reportData.scenario = {
                        scenarioName: scenarioName,
                        configId: configId,
                        depositName: depositName,
                        depositId: depositId,
                        blendCode: document.getElementById('blend_code').value || null,
                        sizeFractionMm: document.getElementById('size_fraction_mm').value || null,
                        applicationRate: document.getElementById('application_rate_t_ha').value,
                        mgoPercent: document.getElementById('mgo_percent').value || null,
                        caoPercent: document.getElementById('cao_percent').value || null,
                        chemistryFactorK: document.getElementById('chemistry_factor_K').value || null,
                        climateBucket: document.getElementById('climate_bucket').value
                    };
                    
                    // Update scenario dropdowns
                    updateScenarioDropdowns();
                    
                    document.getElementById('configForm').reset();
                    document.getElementById('chemistry_factor_K').value = '';
                } else {
                    showMessage('configMessage', result.detail || 'Error creating scenario', true);
                }
            } catch (error) {
                let errorMessage = 'Error creating scenario';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showMessage('configMessage', errorMessage, true);
            }
        });
        
        // Lab Data Form - Add Evidence
        document.getElementById('labDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const scenarioName = document.getElementById('lab_scenario_select').value;
            
            if (!scenarioName) {
                showMessage('labDataMessage', 'Please select a scenario', true);
                document.getElementById('lab_scenario_select').style.borderColor = '#ef4444';
                return;
            }
            document.getElementById('lab_scenario_select').style.borderColor = '#d1d5db';
            
            // Resolve scenario name to config_id
            const configId = scenarioNameToConfigId[scenarioName];
            if (!configId) {
                showMessage('labDataMessage', 'Invalid scenario selected', true);
                return;
            }
            
            const fileInput = document.getElementById('lab_data_file');
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('labDataMessage', 'Please select a CSV file', true);
                fileInput.style.borderColor = '#ef4444';
                return;
            }
            fileInput.style.borderColor = '#d1d5db';
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    let records = parseCSV(csvText);
                    
                    // Validate required columns
                    validateCSVColumns(records, ['time_months', 'co2_uptake_t_per_t']);
                    
                    // Convert to backend format
                    const data = {
                        records: records.map(r => ({
                            config_id: configId,
                            time_months: parseFloat(r.time_months),
                            co2_uptake_t_per_t: parseFloat(r.co2_uptake_t_per_t)
                        }))
                    };
                    
                    const response = await fetchWithRetry(`${API_BASE}/lab-data/ingest`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        let errorMessage = 'Error uploading simulation laboratory testing data';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (e) {
                            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        showMessage('labDataMessage', errorMessage, true);
                        return;
                    }
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('labDataMessage', result.message || 'Simulation laboratory testing data uploaded successfully!', false);
                        
                        // Store lab data for report
                        reportData.labData = {
                            configId: configId,
                            records: data.records
                        };
                        
                        document.getElementById('labDataForm').reset();
                        updateScenarioDropdowns();
                    } else {
                        showMessage('labDataMessage', result.detail || 'Error uploading simulation laboratory testing data', true);
                    }
                } catch (error) {
                    let errorMessage = 'Error processing file';
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                    showMessage('labDataMessage', errorMessage, true);
                }
            };
            
            reader.onerror = () => {
                showMessage('labDataMessage', 'Error reading file', true);
            };
            
            reader.readAsText(file);
        });
        
        // Soil Data Form - Add Evidence
        document.getElementById('soilDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('soil_data_file');
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('soilDataMessage', 'Please select a CSV file', true);
                fileInput.style.borderColor = '#ef4444';
                return;
            }
            fileInput.style.borderColor = '#d1d5db';
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const csvText = event.target.result;
                    let records = parseSoilCSV(csvText);
                    
                    // Validate soil data
                    records = validateSoilData(records);
                    
                    // Store soil analysis data for report (not sent to backend)
                    reportData.soilAnalysis = {
                        records: records
                    };
                    
                    showMessage('soilDataMessage', `Soil laboratory analysis data processed successfully! (${records.length} properties)`, false);
                    document.getElementById('soilDataForm').reset();
                } catch (error) {
                    showMessage('soilDataMessage', `Error: ${error.message}`, true);
                }
            };
            
            reader.onerror = () => {
                showMessage('soilDataMessage', 'Error reading file', true);
            };
            
            reader.readAsText(file);
        });
        
        // Field Data Form - Add Evidence
        document.getElementById('fieldDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const scenarioName = document.getElementById('field_scenario_select').value;
            
            if (!scenarioName) {
                showMessage('fieldDataMessage', 'Please select a scenario', true);
                document.getElementById('field_scenario_select').style.borderColor = '#ef4444';
                return;
            }
            document.getElementById('field_scenario_select').style.borderColor = '#d1d5db';
            
            // Resolve scenario name to config_id
            const configId = scenarioNameToConfigId[scenarioName];
            if (!configId) {
                showMessage('fieldDataMessage', 'Invalid scenario selected', true);
                return;
            }
            
            const fileInput = document.getElementById('field_data_file');
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('fieldDataMessage', 'Please select a CSV file', true);
                fileInput.style.borderColor = '#ef4444';
                return;
            }
            fileInput.style.borderColor = '#d1d5db';
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    let records = parseCSV(csvText);
                    
                    // Validate required columns
                    validateCSVColumns(records, ['window_start', 'window_end', 'co2_removed_t_ha']);
                    
                    // Convert to backend format
                    const data = {
                        records: records.map(r => ({
                            config_id: configId,
                            window_start: parseInt(r.window_start),
                            window_end: parseInt(r.window_end),
                            co2_removed_t_ha: parseFloat(r.co2_removed_t_ha)
                        }))
                    };
                    
                    const response = await fetchWithRetry(`${API_BASE}/field-data/ingest`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        let errorMessage = 'Error uploading field observation data';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (e) {
                            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        showMessage('fieldDataMessage', errorMessage, true);
                        return;
                    }
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showMessage('fieldDataMessage', result.message || 'Field observation data uploaded successfully!', false);
                        
                        // Store field data for report
                        reportData.fieldData = {
                            configId: configId,
                            records: data.records
                        };
                        
                        document.getElementById('fieldDataForm').reset();
                        updateScenarioDropdowns();
                    } else {
                        showMessage('fieldDataMessage', result.detail || 'Error uploading field observation data', true);
                    }
                        } catch (error) {
                            let errorMessage = 'Error uploading field data';
                            if (error instanceof TypeError && error.message.includes('fetch')) {
                                errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
                            } else {
                                errorMessage = `Error: ${error.message}`;
                            }
                            showMessage('fieldDataMessage', errorMessage, true);
                        }
            };
            
            reader.onerror = () => {
                showMessage('fieldDataMessage', 'Error reading file', true);
            };
            
            reader.readAsText(file);
        });
        
        // Analysis Form - Run Analysis (combines update state, simulate, and get results)
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('runAnalysisBtn');
            const resultsDiv = document.getElementById('analysisResults');
            const scenarioName = document.getElementById('analysis_scenario_select').value;
            
            if (!scenarioName) {
                showMessage('analysisMessage', 'Please select a scenario', true);
                document.getElementById('analysis_scenario_select').style.borderColor = '#ef4444';
                return;
            }
            document.getElementById('analysis_scenario_select').style.borderColor = '#d1d5db';
            
            // Resolve scenario name to config_id
            const configId = scenarioNameToConfigId[scenarioName];
            if (!configId) {
                showMessage('analysisMessage', 'Invalid scenario selected', true);
                return;
            }
            
            const nRuns = parseInt(document.getElementById('n_runs').value);
            const riskProfile = document.getElementById('risk_profile').value || null;
            
            btn.disabled = true;
            btn.textContent = 'Running analysis...';
            resultsDiv.innerHTML = '<p>Updating model state...</p>';
            resultsDiv.classList.add('show');
            
            try {
                // Step 1: Update Model State
                const updateResponse = await fetchWithRetry(`${API_BASE}/model/update-state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config_id: configId })
                });
                
                if (!updateResponse.ok) {
                    let errorMessage = 'Failed to update model state';
                    try {
                        const error = await updateResponse.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${updateResponse.status}: ${updateResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                resultsDiv.innerHTML = '<p>Model state updated. Running simulations...</p>';
                
                // Step 2: Run Simulation
                const simResponse = await fetchWithRetry(`${API_BASE}/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_id: configId,
                        n_runs: nRuns,
                        risk_profile: riskProfile
                    })
                }, MAX_RETRIES, INITIAL_RETRY_DELAY, 60000); // 60s timeout for simulation
                
                if (!simResponse.ok) {
                    let errorMessage = 'Failed to run simulation';
                    try {
                        const error = await simResponse.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${simResponse.status}: ${simResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                resultsDiv.innerHTML = '<p>Simulation complete. Retrieving results...</p>';
                
                // Step 3: Get Results
                const resultsResponse = await fetchWithRetry(`${API_BASE}/results/${configId}`);
                
                if (!resultsResponse.ok) {
                    let errorMessage = 'Failed to retrieve results';
                    try {
                        const error = await resultsResponse.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${resultsResponse.status}: ${resultsResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const results = await resultsResponse.json();
                
                // Display results with explanations
                const stats = results.statistics || {};
                const target = results.target;
                const pHit = results.p_hit;
                
                let resultsHTML = '<h3>Analysis Results (10-year horizon)</h3>';
                resultsHTML += '<p class="intro-text">All values are per hectare over a 10-year period. The 5th percentile value is the conservative figure that can be used for crediting.</p>';
                
                resultsHTML += '<div class="grid" style="margin-top: 20px;">';
                
                        // Mean CO2 Removal
                        resultsHTML += `
                            <div class="result-card">
                                <h4>Mean COâ‚‚ Removal</h4>
                                <div class="result-value">${stats.mean ? stats.mean.toFixed(2) : 'â€”'} <span style="font-size: 16px; color: var(--text-muted);">tCOâ‚‚/ha</span></div>
                                <p class="result-explanation">The average outcome across all Monte Carlo simulations. This represents the "typical" expected performance over 10 years, calculated as the mean of all simulated outcomes.</p>
                            </div>
                        `;
                
                // 5th Percentile (Conservative)
                resultsHTML += `
                    <div class="result-card" style="border: 2px solid var(--accent-primary); background: var(--accent-light);">
                        <h4>5th Percentile (Conservative)</h4>
                        <div class="result-value">${stats.p5 ? stats.p5.toFixed(2) : 'â€”'} <span style="font-size: 16px; color: var(--text-muted);">tCOâ‚‚/ha</span></div>
                        <p class="result-explanation">We are 95% confident that actual COâ‚‚ removal will be at or above this value. This conservative estimate is the figure intended for carbon credit issuance, ensuring credits are only issued for COâ‚‚ removal we can be highly confident about.</p>
                    </div>
                `;
                
                        // 50th Percentile (Median)
                        resultsHTML += `
                            <div class="result-card">
                                <h4>50th Percentile (Median)</h4>
                                <div class="result-value">${stats.p50 ? stats.p50.toFixed(2) : 'â€”'} <span style="font-size: 16px; color: var(--text-muted);">tCOâ‚‚/ha</span></div>
                                <p class="result-explanation">Half of all simulated outcomes are above this value and half are below. This median represents the central tendency of the distribution and provides a balanced view of expected performance.</p>
                            </div>
                        `;
                        
                        // 95th Percentile
                        resultsHTML += `
                            <div class="result-card">
                                <h4>95th Percentile</h4>
                                <div class="result-value">${stats.p95 ? stats.p95.toFixed(2) : 'â€”'} <span style="font-size: 16px; color: var(--text-muted);">tCOâ‚‚/ha</span></div>
                                <p class="result-explanation">We are 95% confident that actual COâ‚‚ removal will be at or below this value. This represents the upper end of plausible outcomes and shows the optimistic end of the uncertainty range.</p>
                            </div>
                        `;
                
                resultsHTML += '</div>';
                
                        // Probability of meeting target
                        if (target !== undefined && pHit !== undefined) {
                            resultsHTML += `
                                <div class="section-divider" style="margin: 40px 0 32px 0;"></div>
                                <h3>Probability of Meeting Target</h3>
                                <div class="result-card">
                                    <p class="intro-text">Target value: <strong>${target.toFixed(2)} tCOâ‚‚/ha</strong></p>
                                    <p class="intro-text" style="margin-bottom: 20px;">Probability that total COâ‚‚ removal meets or exceeds this target:</p>
                                    <div class="result-value">${(pHit * 100).toFixed(1)}%</div>
                                    <p class="result-explanation">This metric is useful for internal investment decisions: it answers the question "How likely is this scenario to hit our required COâ‚‚ performance threshold?" A higher probability indicates greater confidence in meeting the target.</p>
                                </div>
                            `;
                        }
                
                resultsDiv.innerHTML = resultsHTML;
                
                // Store analysis results for report
                reportData.analysisResults = {
                    configId: configId,
                    nRuns: nRuns,
                    riskProfile: riskProfile,
                    statistics: stats,
                    target: target,
                    pHit: pHit
                };
                
                showMessage('analysisMessage', 'Analysis completed successfully!', false);
                
            } catch (error) {
                let errorMessage = 'Error running analysis';
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showMessage('analysisMessage', errorMessage, true);
                resultsDiv.innerHTML = `<p class="error-message">${errorMessage}</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Full Analysis';
            }
        });
        
        // Generate Report Function
        function generateReport() {
            const textarea = document.getElementById('reportTextarea');
            const downloadBtn = document.getElementById('downloadReportBtn');
            
            let report = '';
            
            // Header
            report += '='.repeat(80) + '\n';
            report += 'COâ‚‚ RETENTION SIMULATOR - ANALYSIS REPORT\n';
            report += '='.repeat(80) + '\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // SECTION 1: FULL NARRATIVE (Parts 1-4)
            report += FULL_NARRATIVE.trim();
            report += '\n\n';
            
            // SECTION 2: MATHEMATICAL MODEL EXPLANATION
            report += '='.repeat(80) + '\n';
            report += 'MATHEMATICAL MODEL EXPLANATION\n';
            report += '='.repeat(80) + '\n\n';
            
            report += '### Bayesian Updating\n\n';
            report += 'The model uses Bayesian updating to combine simulation laboratory testing and field observation data to jointly update the latent variables (weathering rate and retention factor). When new evidence is provided, the model revises its understanding of these parameters in a principled way. As more evidence accumulates, the uncertainty around these parameters shrinks, leading to more confident predictions. Importantly, past data are not re-injected directly into the model; only the updated state (the posterior distribution) is carried forward to the next time step. This ensures that the model learns continuously from evidence without double-counting information.\n\n';
            
            report += '### Markov State Transition Structure\n\n';
            report += 'The model uses a Markov process structure, meaning each monthly forecast depends only on the previous month\'s state plus process noise. This structure prevents inappropriate reuse of historical laboratory testing data from other deposits or scenarios. Each month\'s state is a function of the immediately preceding month, ensuring that the model responds primarily to recent evidence and does not carry forward irrelevant historical information. This Markov structure matches the continuously progressing nature of weathering behavior, where each month builds upon the previous month\'s state of the material.\n\n';
            
            report += '### Monte Carlo Simulation\n\n';
            report += 'To quantify the full range of possible outcomes, the system runs thousands of Monte Carlo simulations. Each simulation represents one plausible future trajectory, sampling different values from the uncertainty distributions for weathering rates, retention factors, and environmental conditions. These thousands of sampled trajectories collectively cover the full range of possible futures. Percentiles (5th, 50th, 95th) are derived by sorting all simulation outcomes and identifying the values at these percentile positions. For example, the 5th percentile is the value below which 5% of all outcomes fall, meaning 95% of outcomes are at or above this value. The 5th percentile is used for conservative credit issuance because it represents a level of performance we can be at least 95% confident will be exceeded, ensuring credits reflect a guaranteed minimum level of removal.\n\n';
            
            report += '### Explanations for Non-Technical Regulatory Reviewers\n\n';
            report += 'The model learns from evidence the same way repeated measurements refine a scale: each new measurement (laboratory test or field observation) helps narrow down the true value. Think of it like estimating the weight of an object. The first measurement gives you a rough idea, but as you take more measurements, you become increasingly confident about the true weight. Similarly, the model starts with initial estimates (priors) and refines them as more evidence becomes available.\n\n';
            report += 'At a more technical level, the model tracks two key properties: how fast the rock reacts with COâ‚‚ (weathering rate) and how much of that reacted COâ‚‚ stays stored (retention factor). These properties are not directly observable, so the model infers them from measurements. Each month, the model predicts how much COâ‚‚ will be removed based on the current state, then updates its understanding when new measurements arrive.\n\n';
            report += 'The uncertainty in predictions comes from three main sources: measurement error (no measurement is perfect), natural variability (weathering rates vary naturally), and uncertainty about future conditions (we cannot predict the exact climate or soil conditions 10 years ahead). The model accounts for all these sources of uncertainty by running thousands of simulations, each representing one possible future. The conservative 5th percentile value ensures that even in the worst 5% of plausible futures, the predicted COâ‚‚ removal will still be achieved or exceeded.\n\n';
            
            report += '\n\n';
            
            // SECTION 3: SCENARIO INPUT SUMMARY
            report += '='.repeat(80) + '\n';
            report += 'SCENARIO INPUT SUMMARY\n';
            report += '-'.repeat(80) + '\n\n';
            
            if (reportData.scenario) {
                const s = reportData.scenario;
                report += `Scenario Name: ${s.scenarioName}\n`;
                // Configuration ID is internal only, not shown to user
                report += `Deposit Name: ${s.depositName}\n`;
                report += `Deposit ID: ${s.depositId}\n`;
                if (s.blendCode) report += `Rock Product Name: ${s.blendCode}\n`;
                if (s.sizeFractionMm) report += `Size Fraction: ${s.sizeFractionMm} mm\n`;
                report += `Application Rate: ${s.applicationRate} t/ha\n`;
                if (s.mgoPercent) report += `MgO Content: ${s.mgoPercent}% by weight\n`;
                if (s.caoPercent) report += `CaO Content: ${s.caoPercent}% by weight\n`;
                if (s.chemistryFactorK) report += `Chemistry Factor K: ${s.chemistryFactorK} (calculated from MgO% and CaO%)\n`;
                report += `Climate Setting: ${s.climateBucket}\n`;
            } else {
                report += 'No scenario data available. Please define a scenario first.\n';
            }
            
            report += '\n\n';
            
            // SECTION 4: SIMULATION LABORATORY TESTING DATA SUMMARY
            report += '='.repeat(80) + '\n';
            report += 'SIMULATION LABORATORY TESTING DATA SUMMARY\n';
            report += '-'.repeat(80) + '\n\n';
            report += 'Simulation laboratory testing (verification testing) involves controlled lab experiments performed by the team to verify whether the simulator\'s predicted COâ‚‚ uptake curves match newly observed controlled measurements. These are model verification tests, not related to soil samples or field sites.\n\n';
            
            if (reportData.labData && reportData.labData.records) {
                report += `Simulation Laboratory Testing Data (${reportData.labData.records.length} records):\n`;
                reportData.labData.records.forEach((record, idx) => {
                    report += `  Record ${idx + 1}: time_months = ${record.time_months}, co2_uptake_t_per_t = ${record.co2_uptake_t_per_t}\n`;
                });
            } else {
                report += 'No simulation laboratory testing data available.\n';
            }
            
            report += '\n\n';
            
            // SECTION 5: SOIL LABORATORY ANALYSIS SUMMARY
            report += '='.repeat(80) + '\n';
            report += 'SOIL LABORATORY ANALYSIS SUMMARY\n';
            report += '-'.repeat(80) + '\n\n';
            report += 'Soil laboratory analysis consists of physical soil samples taken from deployment sites and analyzed in a laboratory. This data provides site-specific soil properties such as pH, cation exchange capacity (CEC), electrical conductivity (EC), bulk density, texture, mineralogy, and organic matter content. This information helps characterize the deployment environment.\n\n';
            
            if (reportData.soilAnalysis && reportData.soilAnalysis.records) {
                report += `Soil Laboratory Analysis Data (${reportData.soilAnalysis.records.length} properties):\n`;
                reportData.soilAnalysis.records.forEach((record) => {
                    report += `  ${record.soil_property}: ${record.value}\n`;
                });
            } else {
                report += 'No soil laboratory analysis data available.\n';
            }
            
            report += '\n\n';
            
            // SECTION 6: FIELD OBSERVATION DATA SUMMARY
            report += '='.repeat(80) + '\n';
            report += 'FIELD OBSERVATION DATA SUMMARY\n';
            report += '-'.repeat(80) + '\n\n';
            report += 'Field observations capture actual COâ‚‚ removal in real deployment conditions over specific time windows (for example, 12-month periods). These measurements are typically obtained through soil sampling, gas flux measurements, or other field monitoring techniques that quantify the net COâ‚‚ removal achieved in agricultural settings.\n\n';
            
            if (reportData.fieldData && reportData.fieldData.records) {
                report += `Field Observation Data (${reportData.fieldData.records.length} records):\n`;
                reportData.fieldData.records.forEach((record, idx) => {
                    report += `  Record ${idx + 1}: window_start = ${record.window_start}, window_end = ${record.window_end}, co2_removed_t_ha = ${record.co2_removed_t_ha}\n`;
                });
            } else {
                report += 'No field observation data available.\n';
            }
            
            report += '\n\n';
            
            // SECTION 7: SIMULATION RESULTS INTERPRETATION
            report += '='.repeat(80) + '\n';
            report += 'SIMULATION RESULTS INTERPRETATION\n';
            report += '-'.repeat(80) + '\n\n';
            
            if (reportData.analysisResults) {
                const res = reportData.analysisResults;
                report += `Number of Simulation Runs: ${res.nRuns}\n`;
                if (res.riskProfile) report += `Risk Profile Applied: ${res.riskProfile}\n`;
                report += '\n';
                
                // Simplified explanation
                report += 'The simulation results provide a comprehensive view of expected COâ‚‚ removal performance over a 10-year period. These numbers represent different ways of summarizing the distribution of possible outcomes from thousands of Monte Carlo simulations.\n\n';
                
                if (res.statistics) {
                    const stats = res.statistics;
                    if (stats.mean !== undefined) {
                        report += `Mean COâ‚‚ Removal: ${stats.mean.toFixed(2)} tCOâ‚‚/ha\n`;
                        report += '  The average outcome across all Monte Carlo simulations. This represents the "typical" expected performance over 10 years, calculated as the mean of all simulated outcomes.\n\n';
                    }
                    if (stats.p50 !== undefined) {
                        report += `Median (50th Percentile): ${stats.p50.toFixed(2)} tCOâ‚‚/ha\n`;
                        report += '  Half of all simulated outcomes are above this value and half are below. This represents the central tendency of the distribution and provides a balanced view of expected performance.\n\n';
                    }
                    if (stats.p5 !== undefined) {
                        report += `Conservative Value (5th Percentile): ${stats.p5.toFixed(2)} tCOâ‚‚/ha\n`;
                        report += '  We are 95% confident that actual COâ‚‚ removal will be at or above this value. This conservative estimate is the figure intended for carbon credit issuance, ensuring credits are only issued for COâ‚‚ removal we can be highly confident about.\n\n';
                    }
                    if (stats.p95 !== undefined) {
                        report += `Upper Range (95th Percentile): ${stats.p95.toFixed(2)} tCOâ‚‚/ha\n`;
                        report += '  We are 95% confident that actual COâ‚‚ removal will be at or below this value. This represents the upper end of plausible outcomes and shows the optimistic end of the uncertainty range.\n\n';
                    }
                }
                
                // Deeper meaning: distribution shape, variance, evidence strength
                report += 'Distribution Shape and Variance:\n';
                report += 'The spread between the 5th and 95th percentiles represents the uncertainty in the prediction. A wider spread indicates greater uncertainty, while a narrower spread indicates more confidence. This uncertainty arises from three main sources: measurement error in simulation laboratory testing and field observation data, natural variability in weathering rates, and uncertainty about future environmental conditions.\n\n';
                report += 'Evidence Strength:\n';
                report += 'The strength of the evidence is reflected in the confidence intervals. As more simulation laboratory testing and field observation data are collected, the uncertainty range should narrow, providing greater confidence in the predictions. The model\'s Bayesian updating process ensures that each new piece of evidence refines the estimates.\n\n';
                
                if (res.target !== undefined && res.pHit !== undefined) {
                    report += `Target Performance Assessment:\n`;
                    report += `Target Value: ${res.target.toFixed(2)} tCOâ‚‚/ha\n`;
                    report += `Probability of Meeting Target: ${(res.pHit * 100).toFixed(1)}%\n`;
                    report += '  This metric indicates the likelihood of meeting the specified performance threshold. A higher probability indicates greater confidence in meeting the target.\n\n';
                }
                
                // Final statement for regulatory crediting
                report += 'Regulatory Crediting Summary:\n';
                report += 'For carbon credit issuance, the conservative 5th percentile value should be used. This value represents a level of performance we can be at least 95% confident will be achieved or exceeded. This conservative approach protects against over-crediting and ensures the integrity of the carbon credit system. The 5th percentile ensures that even in the worst 5% of plausible futures, the predicted COâ‚‚ removal will still be achieved or exceeded, providing a guaranteed minimum level of removal for credit issuance.\n\n';
            } else {
                report += 'No simulation results available. Please run the analysis first.\n\n';
            }
            
            report += '\n\n';
            
            // Closing statement
            report += '='.repeat(80) + '\n';
            report += 'CLOSING STATEMENT\n';
            report += '-'.repeat(80) + '\n\n';
            report += 'This report contains all scenario inputs, evidence, and modeled outputs used to produce the 10-year COâ‚‚ retention forecast.\n\n';
            
            report += '='.repeat(80) + '\n';
            report += 'END OF REPORT\n';
            report += '='.repeat(80) + '\n';
            
            textarea.value = report;
            downloadBtn.disabled = false;
            showMessage('analysisMessage', 'Report generated successfully!', false);
        }
        
        // Download Report Function
        function downloadReport() {
            const textarea = document.getElementById('reportTextarea');
            const content = textarea.value;
            
            if (!content.trim()) {
                alert('Please generate the report first.');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const scenarioName = reportData.scenario ? reportData.scenario.scenarioName.replace(/[^a-z0-9]/gi, '_') : 'report';
            a.download = `co2_retention_report_${scenarioName}_${timestamp}.txt`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Restart Simulation Function
        function restartSimulation() {
            // Clear all form fields
            document.getElementById('configForm').reset();
            document.getElementById('labDataForm').reset();
            document.getElementById('soilDataForm').reset();
            document.getElementById('fieldDataForm').reset();
            document.getElementById('analysisForm').reset();
            document.getElementById('chemistry_factor_K').value = '';
            document.getElementById('reportTextarea').value = '';
            document.getElementById('downloadReportBtn').disabled = true;
            
            // Clear report data
            reportData.scenario = null;
            reportData.labData = null;
            reportData.soilAnalysis = null;
            reportData.fieldData = null;
            reportData.analysisResults = null;
            
            // Reset dropdowns
            updateScenarioDropdowns();
            
            // Clear results display
            document.getElementById('analysisResults').innerHTML = '';
            document.getElementById('analysisResults').classList.remove('show');
            
            // Clear all error borders
            document.querySelectorAll('input, select').forEach(el => {
                el.style.borderColor = '';
            });
            
            // Navigate to Define Scenario step
            showStep('scenario');
        }
    </script>
</body>
</html>
